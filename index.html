<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Factura 3DCraftRD</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.5.0/frappe-gantt.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a202c, #2d3748);
      color: white;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 900px;
      width: 100%;
      background-color: #2d3748;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      padding: 30px;
      border: 1px solid #4a5568;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #ff9f43;
      gap: 20px;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header img {
      width: 60px;
      height: auto;
    }

    .brand-name {
      font-size: 2.5rem;
      font-weight: bold;
      color: #ff9f43;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    h1 {
      margin: 0;
      font-size: 2.2rem;
      color: white;
      text-align: center;
    }

    form input[type="number"],
    form input[type="text"],
    form select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #4a5568;
      border-radius: 8px;
      margin-top: 5px;
      background-color: #3c4758;
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    form input[type="number"]:focus,
    form input[type="text"]:focus,
    form select:focus {
      outline: none;
      border-color: #ff9f43;
      box-shadow: 0 0 0 3px rgba(255, 159, 67, 0.2);
    }

    label {
      display: block;
      margin-top: 18px;
      font-weight: 600;
      color: #e2e8f0;
    }

    .results {
      margin-top: 30px;
      background-color: #3c4758;
      padding: 25px;
      border-radius: 10px;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
    }

    .results div {
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #4a5568;
    }

    .results h3 {
      margin-top: 0;
      padding-bottom: 15px;
      margin-bottom: 15px;
      border-bottom: 2px solid #ff9f43;
      color: #ff9f43;
      font-size: 1.4rem;
    }

    .customer-results {
      background: linear-gradient(to right, #2c5282, #2a4365);
      border-left: 5px solid #ff9f43;
    }

    .customer-results div:last-child {
      border-bottom: none;
      font-weight: bold;
      font-size: 1.2rem;
      padding-top: 15px;
      color: #ff9f43;
    }

    .btn {
      display: inline-block;
      margin-top: 10px;
      margin-right: 10px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      color: white;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
    }

    .btn-export { background: linear-gradient(to right, #4CAF50, #2E7D32); }
    .btn-save { background: linear-gradient(to right, #2196F3, #0D47A1); }
    .btn-clear { background: linear-gradient(to right, #f44336, #b71c1c); }
    .btn-dashboard { background: linear-gradient(to right, #FF9800, #F57C00); }
    .btn-template { background: linear-gradient(to right, #607D8B, #455A64); }
    .btn-payment { background: linear-gradient(to right, #FFC107, #FFA000); }
    .btn-projects { background: linear-gradient(to right, #00BCD4, #0097A7); }
    .btn-whatsapp { background: linear-gradient(to right, #25D366, #128C7E); }
    .btn-client { background: linear-gradient(to right, #9C27B0, #7B1FA2); }

    .history {
      margin-top: 30px;
      background-color: #3c4758;
      padding: 20px;
      border-radius: 10px;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
    }

    .history-item {
      margin-bottom: 12px;
      padding: 15px;
      border-radius: 8px;
      background-color: #2d3748;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .history-item:hover {
      background-color: #4a5568;
      transform: translateX(5px);
    }
    
    .invoice-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 20px;
      padding: 20px;
      background-color: #3c4758;
      border-radius: 10px;
    }
    
    .invoice-header div {
      flex: 1;
      min-width: 250px;
    }
    
    .section-title {
      color: #ff9f43;
      margin-top: 25px;
      margin-bottom: 10px;
      font-size: 1.3rem;
      padding-left: 10px;
      border-left: 4px solid #ff9f43;
    }

    .buttons-container {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 30px;
      justify-content: center;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      overflow: auto;
    }

    .modal-content {
      background-color: #2d3748;
      margin: 5% auto;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      width: 80%;
      max-width: 900px;
      border: 1px solid #4a5568;
      position: relative;
    }

    .close {
      position: absolute;
      right: 25px;
      top: 15px;
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: white;
    }

    .chart-container {
      margin-top: 20px;
      height: 400px;
      background-color: #3c4758;
      border-radius: 8px;
      padding: 15px;
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #4a5568;
      flex-wrap: wrap;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background-color: #3c4758;
      border: none;
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .tab.active {
      background-color: #4a5568;
      color: #ff9f43;
      border-bottom: 3px solid #ff9f43;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background-color: #3c4758;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .card:hover {
      background-color: #4a5568;
      transform: translateY(-3px);
    }

    .search-box {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #4a5568;
      border-radius: 8px;
      margin-bottom: 20px;
      background-color: #3c4758;
      color: white;
      font-size: 1rem;
    }

    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
      margin-left: 8px;
    }

    .status-received { background-color: #FF9800; color: #fff; }
    .status-printing { background-color: #2196F3; color: #fff; }
    .status-completed { background-color: #4CAF50; color: #fff; }
    .status-delivered { background-color: #9C27B0; color: #fff; }
    .status-paid { background-color: #607D8B; color: #fff; }
    .status-pending { background-color: #f44336; color: #fff; }
    .status-design { background-color: #673AB7; color: #fff; }
    .status-approval { background-color: #3F51B5; color: #fff; }
    .status-preparation { background-color: #009688; color: #fff; }
    .status-postprocessing { background-color: #795548; color: #fff; }
    .status-quality { background-color: #CDDC39; color: #333; }

    .alert-banner {
      background-color: #f44336;
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
      100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
    }

    .alert-banner.warning { background-color: #FF9800; }
    .alert-banner.info { background-color: #2196F3; }
    .alert-banner.success { background-color: #4CAF50; }

    .history-item-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .history-item-buttons button {
      padding: 5px 10px;
      font-size: 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-edit { background-color: #2196F3; color: white; }
    .btn-delete { background-color: #f44336; color: white; }

    .payment-section {
      margin-top: 20px;
      padding: 15px;
      background-color: #3c4758;
      border-radius: 8px;
      display: none;
    }

    .payment-section.active { display: block; }

    .checklist-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background-color: #3c4758;
      border-radius: 8px;
    }

    .checklist-item input[type="checkbox"] { margin-right: 10px; }
    .checklist-item label { margin: 0; flex-grow: 1; }

    .task-assignment {
      margin-top: 15px;
      padding: 15px;
      background-color: #3c4758;
      border-radius: 8px;
    }

    .task-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 10px;
      background-color: #2d3748;
      border-radius: 6px;
    }

    .whatsapp-modal-content { max-width: 500px; }

    .whatsapp-message {
      background-color: #ECE5DD;
      color: #000;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    .whatsapp-templates { margin-top: 15px; }

    .whatsapp-template {
      padding: 10px;
      margin-bottom: 10px;
      background-color: #3c4758;
      border-radius: 8px;
      cursor: pointer;
    }

    .whatsapp-template:hover { background-color: #4a5568; }

    .gantt-container {
      width: 100%;
      height: 500px;
      overflow-x: auto;
      margin-top: 20px;
    }

    .project-stages {
      display: flex;
      margin-bottom: 20px;
      overflow-x: auto;
    }

    .stage {
      min-width: 200px;
      margin-right: 10px;
      background-color: #3c4758;
      border-radius: 8px;
      padding: 10px;
    }

    .stage-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #ff9f43;
    }

    .resource-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .resource-card {
      background-color: #3c4758;
      padding: 15px;
      border-radius: 8px;
    }

    .client-portal {
      background-color: #3c4758;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .client-project {
      margin-bottom: 15px;
      padding: 15px;
      background-color: #2d3748;
      border-radius: 8px;
    }

    @media (max-width: 600px) {
      .header { flex-direction: column; text-align: center; }
      .logo-container { justify-content: center; }
      .invoice-header { flex-direction: column; }
      .buttons-container { flex-direction: column; }
      .modal-content { width: 95%; margin: 10% auto; padding: 15px; }
      .tabs { flex-direction: column; }
      .tab { width: 100%; text-align: left; }
      .project-stages { flex-direction: column; }
      .stage { margin-bottom: 10px; margin-right: 0; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="logo-container">
      <img src="logo.png" alt="Logo 3DCraftRD" />
      <div class="brand-name">3DCraftRD</div>
    </div>
    <h1>Factura</h1>
  </div>

  <div style="text-align:right; margin-bottom:15px;">
    <button class="btn-dashboard" onclick="openDashboard()">Dashboard</button>
    <button class="btn-projects" onclick="openProjects()">Gestión de Proyectos</button>
    <button class="btn-client" onclick="openClientPortal()">Portal Cliente</button>
  </div>

  <div id="alerts-container"></div>

  <div class="invoice-header">
    <div>
      <label for="customerName">Nombre del Cliente</label>
      <input type="text" id="customerName" placeholder="Ingrese el nombre del cliente" list="customersList" />
      <datalist id="customersList"></datalist>
    </div>
    <div>
      <label for="invoiceNumber">Número de Factura</label>
      <input type="text" id="invoiceNumber" readonly />
    </div>
    <div>
      <label for="status">Estado del Pedido</label>
      <select id="status" onchange="togglePaymentSection()">
        <option value="design">Diseño</option>
        <option value="approval">Aprobación</option>
        <option value="preparation">Preparación</option>
        <option value="printing">Impresión</option>
        <option value="postprocessing">Post-procesado</option>
        <option value="quality">Control de Calidad</option>
        <option value="delivered">Entregado</option>
        <option value="paid">Pagado</option>
      </select>
    </div>
  </div>

  <div id="payment-section" class="payment-section">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      <div>
        <label for="amountPaid">Monto Abonado (RD$)</label>
        <input type="number" id="amountPaid" value="0" min="0" />
      </div>
      <div>
        <label for="remainingBalance">Saldo Pendiente (RD$)</label>
        <input type="number" id="remainingBalance" value="0" readonly />
      </div>
    </div>
  </div>

  <form id="calculator-form">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      <div>
        <label for="filamentType">Tipo de Filamento</label>
        <select id="filamentType">
          <option value="1600">PLA (RD$1,600/kg)</option>
          <option value="2000">PETG (RD$2,000/kg)</option>
          <option value="2250">ABS (RD$2,250/kg)</option>
          <option value="2150">ASA (RD$2,150/kg)</option>
          <option value="custom">Personalizado</option>
        </select>

        <label for="filamentPrice">Precio del filamento (RD$/kg)</label>
        <input type="number" id="filamentPrice" value="1600" />

        <label for="weight">Peso del modelo (g)</label>
        <input type="number" id="weight" value="150" />

        <label for="electricityPrice">Precio de la electricidad (RD$/kWh)</label>
        <input type="number" step="0.01" id="electricityPrice" value="2.80" />

        <label for="printHours">Horas de impresión</label>
        <input type="number" id="printHours" value="6" />
      </div>
      
      <div>
        <label for="laborCost">Mano de obra (RD$)</label>
        <input type="number" id="laborCost" value="150" />

        <label for="otherCosts">Otros costos (RD$)</label>
        <input type="number" id="otherCosts" value="100" />

        <label for="maintenanceCost">Costo de mantenimiento (RD$)</label>
        <input type="number" id="maintenanceCost" value="50" />

        <label for="printerDepreciation">Depreciación de impresora (RD$/hora)</label>
        <input type="number" step="0.01" id="printerDepreciation" value="14.00" />

        <label for="margin">Margen de ganancia (%)</label>
        <input type="number" id="margin" value="40" />
      </div>
    </div>
  </form>

  <div class="section-title">Resultados (Administrador)</div>
  <div class="results">
    <div><span>Costo del material:</span> <span>RD$<span id="materialCost">0.00</span></span></div>
    <div><span>Costo de energía eléctrica:</span> <span>RD$<span id="energyCost">0.00</span></span></div>
    <div><span>Costo de impresión:</span> <span>RD$<span id="printingCost">0.00</span></span></div>
    <div><span>Costo de mantenimiento:</span> <span>RD$<span id="maintenanceCostAdmin">0.00</span></span></div>
    <div><span>Costo de mano de obra:</span> <span>RD$<span id="laborCostAdmin">0.00</span></span></div>
    <div><span>Otros costos:</span> <span>RD$<span id="otherCostsAdmin">0.00</span></span></div>
    <div><span>Costo total:</span> <span>RD$<span id="totalCost">0.00</span></span></div>
    <div><span>Precio sugerido:</span> <span>RD$<span id="suggestedPrice">0.00</span></span></div>
    <div><span>Ganancia neta:</span> <span>RD$<span id="netProfit">0.00</span></span></div>
  </div>

  <div class="section-title">Detalles de la Factura (Cliente)</div>
  <div class="results customer-results">
    <div><span>Materiales utilizados:</span> <span>RD$<span id="customerMaterialCost">0.00</span></span></div>
    <div><span>Consumo energético:</span> <span>RD$<span id="customerEnergyCost">0.00</span></span></div>
    <div><span>Tiempo de máquina:</span> <span>RD$<span id="customerPrintingCost">0.00</span></span></div>
    <div><span>Servicio técnico:</span> <span>RD$<span id="customerServiceCost">0.00</span></span></div>
    <div><span>Precio Total:</span> <span>RD$<span id="customerTotalPrice">0.00</span></span></div>
  </div>

  <div class="buttons-container">
    <button class="btn-export" onclick="exportToPDF()">Exportar a PDF</button>
    <button class="btn-save" onclick="saveToHistory()">Guardar en Historial</button>
    <button class="btn-clear" onclick="clearForm()">Limpiar Formulario</button>
    <button class="btn-template" onclick="saveTemplate()">Guardar Plantilla</button>
    <button class="btn-payment" onclick="markAsPaid()">Marcar como Pagado</button>
    <button class="btn-whatsapp" onclick="openWhatsAppModal()">Enviar por WhatsApp</button>
  </div>

  <div class="history" id="history-section">
    <h3>Historial de Impresiones</h3>
    <div id="history-list"></div>
  </div>
</div>

<!-- Modal Dashboard -->
<div id="dashboardModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('dashboardModal')">&times;</span>
    <h2>Dashboard Analytics</h2>
    
    <div class="tabs">
      <button class="tab active" onclick="openTab(event, 'stats-tab')">Estadísticas</button>
      <button class="tab" onclick="openTab(event, 'customers-tab')">Clientes</button>
      <button class="tab" onclick="openTab(event, 'templates-tab')">Plantillas</button>
      <button class="tab" onclick="openTab(event, 'inventory-tab')">Inventario</button>
      <button class="tab" onclick="openTab(event, 'reports-tab')">Reportes</button>
    </div>
    
    <div id="stats-tab" class="tab-content active">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <h3>Ganancias Mensuales</h3>
          <div class="chart-container">
            <canvas id="monthlyProfitChart"></canvas>
          </div>
        </div>
        <div>
          <h3>Uso de Filamento</h3>
          <div class="chart-container">
            <canvas id="filamentUsageChart"></canvas>
          </div>
        </div>
      </div>
      <div style="margin-top: 20px;">
        <h3>Margen por Tipo de Filamento</h3>
        <div class="chart-container">
          <canvas id="filamentMarginChart"></canvas>
        </div>
      </div>
      <div style="margin-top: 20px;">
        <h3>Actividad Reciente</h3>
        <div id="recent-activity" style="max-height: 300px; overflow-y: auto;"></div>
      </div>
    </div>
    
    <div id="customers-tab" class="tab-content">
      <input type="text" id="customerSearch" class="search-box" placeholder="Buscar clientes..." oninput="searchCustomers()" />
      <div id="customers-list"></div>
    </div>
    
    <div id="templates-tab" class="tab-content">
      <input type="text" id="templateSearch" class="search-box" placeholder="Buscar plantillas..." oninput="searchTemplates()" />
      <div id="templates-list"></div>
    </div>
    
    <div id="inventory-tab" class="tab-content">
      <h3>Inventario de Filamento</h3>
      <div id="inventory-list"></div>
      
      <h3 style="margin-top: 30px;">Agregar al Inventario</h3>
      <form id="inventory-form">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div>
            <label for="inv-filament-type">Tipo de Filamento</label>
            <select id="inv-filament-type">
              <option value="PLA">PLA</option>
              <option value="PETG">PETG</option>
              <option value="ABS">ABS</option>
              <option value="ASA">ASA</option>
              <option value="Otro">Otro</option>
            </select>
            
            <label for="inv-color">Color</label>
            <input type="text" id="inv-color" placeholder="Ej: Negro, Blanco, etc." />
          </div>
          <div>
            <label for="inv-quantity">Cantidad (kg)</label>
            <input type="number" step="0.01" id="inv-quantity" value="1.00" />
            
            <label for="inv-price">Precio por kg (RD$)</label>
            <input type="number" id="inv-price" value="1600" />
          </div>
        </div>
        <button type="button" class="btn-save" style="margin-top: 15px;" onclick="addToInventory()">Agregar al Inventario</button>
      </form>
    </div>
    
    <div id="reports-tab" class="tab-content">
      <h3>Pagos Pendientes</h3>
      <div id="pending-payments-list"></div>
      
      <h3 style="margin-top: 30px;">Resumen Financiero</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="results">
          <div><span>Ventas Totales:</span> <span>RD$<span id="total-sales">0.00</span></span></div>
          <div><span>Total Pendiente:</span> <span>RD$<span id="total-pending">0.00</span></span></div>
          <div><span>Costos Totales:</span> <span>RD$<span id="total-costs">0.00</span></span></div>
        </div>
        <div class="results">
          <div><span>Ganancias Totales:</span> <span>RD$<span id="total-profit">0.00</span></span></div>
          <div><span>Margen Promedio:</span> <span><span id="avg-margin">0</span>%</span></div>
          <div><span>Facturas Totales:</span> <span><span id="total-invoices">0</span></span></div>
        </div>
      </div>
      
      <div style="margin-top: 30px;">
        <h3>Proyección de Flujo de Caja</h3>
        <div class="chart-container">
          <canvas id="cashFlowChart"></canvas>
        </div>
      </div>
      
      <div style="margin-top: 30px;">
        <button class="btn-export" onclick="generateMonthlyReport()">Generar Reporte Mensual</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Gestión de Proyectos -->
<div id="projectsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('projectsModal')">&times;</span>
    <h2>Gestión de Proyectos</h2>
    
    <div class="tabs">
      <button class="tab active" onclick="openProjectsTab(event, 'gantt-tab')">Línea de Tiempo</button>
      <button class="tab" onclick="openProjectsTab(event, 'stages-tab')">Etapas</button>
      <button class="tab" onclick="openProjectsTab(event, 'resources-tab')">Recursos</button>
    </div>
    
    <div id="gantt-tab" class="tab-content active">
      <h3>Línea de Tiempo de Proyectos</h3>
      <div class="gantt-container" id="gantt-chart"></div>
    </div>
    
    <div id="stages-tab" class="tab-content">
      <h3>Proyectos por Etapa</h3>
      <div class="project-stages" id="project-stages"></div>
    </div>
    
    <div id="resources-tab" class="tab-content">
      <h3>Asignación de Recursos</h3>
      <div class="resource-grid" id="resource-grid"></div>
      
      <h3 style="margin-top: 30px;">Disponibilidad de Impresoras</h3>
      <div class="chart-container">
        <canvas id="printerAvailabilityChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Modal Portal del Cliente -->
<div id="clientPortalModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('clientPortalModal')">&times;</span>
    <h2>Portal del Cliente</h2>
    
    <div class="client-portal">
      <h3>Mis Proyectos</h3>
      <div id="client-projects"></div>
      
      <h3 style="margin-top: 30px;">Aprobación de Diseños</h3>
      <div id="design-approvals"></div>
      
      <h3 style="margin-top: 30px;">Facturas</h3>
      <div id="client-invoices"></div>
    </div>
  </div>
</div>

<!-- Modal WhatsApp -->
<div id="whatsappModal" class="modal">
  <div class="modal-content whatsapp-modal-content">
    <span class="close" onclick="closeModal('whatsappModal')">&times;</span>
    <h2>Enviar Mensaje por WhatsApp</h2>
    
    <div class="whatsapp-message" id="whatsapp-message-preview"></div>
    
    <div class="whatsapp-templates">
      <h3>Plantillas de Mensaje</h3>
      <div class="whatsapp-template" onclick="useWhatsAppTemplate('invoice')">
        <strong>Factura lista</strong>
        <p>Hola {cliente}, tu factura #{factura} está lista. Total: RD${total}. ¿Necesitas alguna aclaración?</p>
      </div>
      <div class="whatsapp-template" onclick="useWhatsAppTemplate('printing')">
        <strong>En impresión</strong>
        <p>Hola {cliente}, tu pedido #{factura} está en proceso de impresión. Te mantendremos informado.</p>
      </div>
      <div class="whatsapp-template" onclick="useWhatsAppTemplate('completed')">
        <strong>Terminado</strong>
        <p>Hola {cliente}, tu pedido #{factura} está terminado. ¿Cuándo podrás recogerlo?</p>
      </div>
      <div class="whatsapp-template" onclick="useWhatsAppTemplate('delivered')">
        <strong>Entregado</strong>
        <p>Hola {cliente}, tu pedido #{factura} ha sido entregado. ¡Gracias por confiar en nosotros!</p>
      </div>
      <div class="whatsapp-template" onclick="useWhatsAppTemplate('payment')">
        <strong>Recordatorio de pago</strong>
        <p>Hola {cliente}, recuerda que tienes un saldo pendiente de RD${saldo} en la factura #{factura}. ¿Necesitas alguna aclaración?</p>
      </div>
      <div class="whatsapp-template" onclick="useWhatsAppTemplate('feedback')">
        <strong>Solicitud de feedback</strong>
        <p>Hola {cliente}, ¿cómo ha sido tu experiencia con nuestro servicio? Agradecemos tus comentarios.</p>
      </div>
    </div>
    
    <div style="margin-top: 20px;">
      <button class="btn-whatsapp" onclick="sendWhatsAppMessage()">Enviar por WhatsApp</button>
      <button class="btn-save" onclick="copyWhatsAppMessage()">Copiar Mensaje</button>
    </div>
  </div>
</div>

<script>
  // Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDh3ERqBfRMjGliGuKxL16wPoGjARQ5L0Q",
    authDomain: "facturas-fa510.firebaseapp.com",
    databaseURL: "https://facturas-fa510-default-rtdb.firebaseio.com",
    projectId: "facturas-fa510",
    storageBucket: "facturas-fa510.appspot.com",
    messagingSenderId: "1045051500553",
    appId: "1:1045051500553:web:180cfd9978cf1f2d2c30d8",
    measurementId: "G-58CQ3L3XNN"
  };

  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Variables globales
  let currentInvoiceId = null;
  let monthlyProfitChart = null;
  let filamentUsageChart = null;
  let filamentMarginChart = null;
  let cashFlowChart = null;
  let printerAvailabilityChart = null;
  let currentWhatsAppTemplate = null;
  let ganttChart = null;

  // Generar número de factura único
  function generateInvoiceNumber() {
    const now = new Date();
    const year = now.getFullYear().toString().slice(-2);
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    return `FAC-${year}${month}${day}-${hours}${minutes}${seconds}`;
  }

  // Inicializar número de factura
  document.getElementById('invoiceNumber').value = generateInvoiceNumber();

  // Mostrar/ocultar sección de pagos según estado
  function togglePaymentSection() {
    const status = document.getElementById("status").value;
    const paymentSection = document.getElementById("payment-section");
    
    if (status === "printing" || status === "postprocessing" || status === "quality") {
      paymentSection.classList.add("active");
      updateRemainingBalance();
    } else {
      paymentSection.classList.remove("active");
    }
  }

  // Actualizar saldo pendiente
  function updateRemainingBalance() {
    const suggestedPrice = parseFloat(document.getElementById("suggestedPrice").textContent) || 0;
    const amountPaid = parseFloat(document.getElementById("amountPaid").value) || 0;
    const remainingBalance = suggestedPrice - amountPaid;
    
    document.getElementById("remainingBalance").value = remainingBalance.toFixed(2);
  }

  // Cálculos
  const results = {
    materialCost: document.getElementById("materialCost"),
    energyCost: document.getElementById("energyCost"),
    printingCost: document.getElementById("printingCost"),
    maintenanceCostAdmin: document.getElementById("maintenanceCostAdmin"),
    laborCostAdmin: document.getElementById("laborCostAdmin"),
    otherCostsAdmin: document.getElementById("otherCostsAdmin"),
    totalCost: document.getElementById("totalCost"),
    suggestedPrice: document.getElementById("suggestedPrice"),
    netProfit: document.getElementById("netProfit"),
    customerMaterialCost: document.getElementById("customerMaterialCost"),
    customerEnergyCost: document.getElementById("customerEnergyCost"),
    customerPrintingCost: document.getElementById("customerPrintingCost"),
    customerServiceCost: document.getElementById("customerServiceCost"),
    customerTotalPrice: document.getElementById("customerTotalPrice")
  };

  function calculateResults() {
    const electricityPrice = parseFloat(document.getElementById("electricityPrice").value) || 0;
    const printHours = parseFloat(document.getElementById("printHours").value) || 0;
    const weight = parseFloat(document.getElementById("weight").value) || 0;
    const filamentPrice = parseFloat(document.getElementById("filamentPrice").value) || 0;
    const laborCost = parseFloat(document.getElementById("laborCost").value) || 0;
    const otherCosts = parseFloat(document.getElementById("otherCosts").value) || 0;
    const maintenanceCost = parseFloat(document.getElementById("maintenanceCost").value) || 0;
    const printerDepreciation = parseFloat(document.getElementById("printerDepreciation").value) || 0;
    const margin = parseFloat(document.getElementById("margin").value) || 0;

    const printerPowerKw = 0.15; // kW

    const energyConsumption = printerPowerKw * printHours;
    const energyCost = energyConsumption * electricityPrice;
    const printingCost = (electricityPrice * printerPowerKw + printerDepreciation) * printHours;
    const materialCost = (weight / 1000) * filamentPrice;
    const totalCost = materialCost + energyCost + printingCost + laborCost + otherCosts + maintenanceCost;
    const suggestedPrice = totalCost * (1 + margin / 100);
    const netProfit = suggestedPrice - totalCost;

    // Resultados para administrador
    results.materialCost.textContent = materialCost.toFixed(2);
    results.energyCost.textContent = energyCost.toFixed(2);
    results.printingCost.textContent = printingCost.toFixed(2);
    results.maintenanceCostAdmin.textContent = maintenanceCost.toFixed(2);
    results.laborCostAdmin.textContent = laborCost.toFixed(2);
    results.otherCostsAdmin.textContent = otherCosts.toFixed(2);
    results.totalCost.textContent = totalCost.toFixed(2);
    results.suggestedPrice.textContent = suggestedPrice.toFixed(2);
    results.netProfit.textContent = netProfit.toFixed(2);

    // Resultados para cliente (ajustados para que sumen exactamente el precio total)
    const serviceCost = laborCost + otherCosts + maintenanceCost;
    const adjustedPrintingCost = printingCost * (suggestedPrice / totalCost);
    const adjustedMaterialCost = materialCost * (suggestedPrice / totalCost);
    const adjustedEnergyCost = energyCost * (suggestedPrice / totalCost);
    const adjustedServiceCost = serviceCost * (suggestedPrice / totalCost);
    
    results.customerMaterialCost.textContent = adjustedMaterialCost.toFixed(2);
    results.customerEnergyCost.textContent = adjustedEnergyCost.toFixed(2);
    results.customerPrintingCost.textContent = adjustedPrintingCost.toFixed(2);
    results.customerServiceCost.textContent = adjustedServiceCost.toFixed(2);
    results.customerTotalPrice.textContent = suggestedPrice.toFixed(2);

    // Actualizar saldo pendiente si la sección de pagos está visible
    if (document.getElementById("payment-section").classList.contains("active")) {
      updateRemainingBalance();
    }
  }

  function exportToPDF() {
    if (typeof window.jspdf === 'undefined') {
      alert('Error: La biblioteca jsPDF no está cargada. Por favor recarga la página.');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const customerName = document.getElementById("customerName").value || "Cliente no especificado";
    const invoiceNumber = document.getElementById("invoiceNumber").value || "FAC-00000";
    
    // Encabezado con logo y nombre
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    
    try {
      doc.addImage("logo.png", "PNG", 20, 15, 25, 25);
    } catch (e) {
      console.log("Logo no encontrado, continuando sin él");
    }
    
    doc.text("3DCraftRD", 105, 20, null, null, "center");
    doc.setFontSize(14);
    doc.text("Factura", 105, 27, null, null, "center");
    
    // Información de la factura
    doc.setFontSize(12);
    doc.text(`Número de Factura: ${invoiceNumber}`, 20, 45);
    doc.text(`Nombre del Cliente: ${customerName}`, 20, 52);
    
    // Fecha
    const now = new Date();
    const dateStr = now.toLocaleDateString();
    doc.text(`Fecha: ${dateStr}`, 180, 45, null, null, "right");
    
    // Resultados para el cliente
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text("Detalles de la Factura (Cliente)", 20, 70);
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    
    let yPos = 80;
    doc.text(`Materiales utilizados: RD$${results.customerMaterialCost.textContent}`, 30, yPos);
    yPos += 10;
    doc.text(`Consumo energético: RD$${results.customerEnergyCost.textContent}`, 30, yPos);
    yPos += 10;
    doc.text(`Tiempo de máquina: RD$${results.customerPrintingCost.textContent}`, 30, yPos);
    yPos += 10;
    doc.text(`Servicio técnico: RD$${results.customerServiceCost.textContent}`, 30, yPos);
    
    // Mostrar información de pagos si está pendiente
    const status = document.getElementById("status").value;
    if (status === "printing" || status === "postprocessing" || status === "quality") {
      const amountPaid = parseFloat(document.getElementById("amountPaid").value) || 0;
      const remainingBalance = parseFloat(document.getElementById("remainingBalance").value) || 0;
      
      yPos += 15;
      doc.text(`Monto abonado: RD$${amountPaid.toFixed(2)}`, 30, yPos);
      yPos += 10;
      doc.text(`Saldo pendiente: RD$${remainingBalance.toFixed(2)}`, 30, yPos);
    }
    
    yPos += 15;
    
    // Precio total
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text(`Precio Total: RD$${results.customerTotalPrice.textContent}`, 30, yPos);
    
    // Nota al pie
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text("Gracias por su preferencia - 3DCraftRD", 105, 280, null, null, "center");
    
    // Guardar el PDF
    doc.save(`Factura_${invoiceNumber}.pdf`);
  }

  async function saveToHistory() {
    const customerName = document.getElementById("customerName").value || "Sin nombre";
    const invoiceNumber = document.getElementById("invoiceNumber").value || generateInvoiceNumber();
    const status = document.getElementById("status").value;
    const amountPaid = parseFloat(document.getElementById("amountPaid").value) || 0;
    
    const invoiceData = {
      date: new Date().toISOString(),
      customerName: customerName,
      invoiceNumber: invoiceNumber,
      status: status,
      electricityPrice: parseFloat(document.getElementById("electricityPrice").value) || 0,
      printHours: parseFloat(document.getElementById("printHours").value) || 0,
      weight: parseFloat(document.getElementById("weight").value) || 0,
      filamentPrice: parseFloat(document.getElementById("filamentPrice").value) || 0,
      filamentType: document.getElementById("filamentType").value,
      laborCost: parseFloat(document.getElementById("laborCost").value) || 0,
      otherCosts: parseFloat(document.getElementById("otherCosts").value) || 0,
      maintenanceCost: parseFloat(document.getElementById("maintenanceCost").value) || 0,
      printerDepreciation: parseFloat(document.getElementById("printerDepreciation").value) || 0,
      margin: parseFloat(document.getElementById("margin").value) || 0,
      totalCost: parseFloat(results.totalCost.textContent) || 0,
      suggestedPrice: parseFloat(results.suggestedPrice.textContent) || 0,
      paid: status === 'paid',
      amountPaid: amountPaid,
      remainingBalance: parseFloat(document.getElementById("remainingBalance").value) || 0
    };
    
    try {
      if (currentInvoiceId) {
        // Actualizar factura existente
        await db.collection("invoices").doc(currentInvoiceId).update(invoiceData);
        alert("Factura actualizada correctamente");
      } else {
        // Crear nueva factura
        await db.collection("invoices").add(invoiceData);
        
        // Actualizar o crear cliente
        const customerQuery = await db.collection("customers").where("name", "==", customerName).get();
        
        if (customerQuery.empty) {
          // Nuevo cliente
          await db.collection("customers").add({
            name: customerName,
            totalSpent: parseFloat(results.suggestedPrice.textContent) || 0,
            invoices: [invoiceNumber],
            lastPurchase: new Date().toISOString(),
            firstPurchase: new Date().toISOString(),
            pendingAmount: status === 'paid' ? 0 : parseFloat(results.suggestedPrice.textContent) - amountPaid || 0
          });
        } else {
          // Cliente existente
          const customerDoc = customerQuery.docs[0];
          const customerData = customerDoc.data();
          const pendingAmount = status === 'paid' ? 
            0 : 
            (customerData.pendingAmount || 0) + (parseFloat(results.suggestedPrice.textContent) - amountPaid) || 0;
          
          await db.collection("customers").doc(customerDoc.id).update({
            totalSpent: (customerData.totalSpent || 0) + parseFloat(results.suggestedPrice.textContent) || 0,
            invoices: [...(customerData.invoices || []), invoiceNumber],
            lastPurchase: new Date().toISOString(),
            pendingAmount: pendingAmount
          });
        }
        
        // Actualizar inventario si el estado no es "received"
        if (status !== 'design' && status !== 'approval') {
          await updateInventory(parseFloat(document.getElementById("weight").value) || 0, document.getElementById("filamentType").value);
        }
        
        alert('Factura guardada con éxito!');
      }
      
      // Generar nuevo número de factura para el próximo
      document.getElementById('invoiceNumber').value = generateInvoiceNumber();
      currentInvoiceId = null; // Resetear el ID de factura actual
      
      // Actualizar historial y alertas
      renderHistory();
      checkAlerts();
    } catch (error) {
      console.error("Error saving invoice:", error);
      alert('Error al guardar la factura');
    }
  }

  async function renderHistory() {
    const list = document.getElementById("history-list");
    list.innerHTML = "";
    
    try {
      const querySnapshot = await db.collection("invoices")
        .orderBy("date", "desc")
        .limit(10)
        .get();
      
      if (querySnapshot.empty) {
        list.innerHTML = `<div style="text-align:center; padding:20px; color:#a0aec0;">No hay registros en el historial</div>`;
        return;
      }
      
      querySnapshot.forEach(doc => {
        const item = doc.data();
        const div = document.createElement("div");
        div.className = "history-item";
        
        let paymentInfo = "";
        if ((item.status === "printing" || item.status === "postprocessing" || item.status === "quality") && item.amountPaid > 0) {
          paymentInfo = `<div><small>Abonado: RD$${item.amountPaid.toFixed(2)} (Saldo: RD$${item.remainingBalance.toFixed(2)})</small></div>`;
        }
        
        div.innerHTML = `
          <strong>${new Date(item.date).toLocaleString()}</strong>
          <span class="status-badge ${getStatusClass(item.status)}">${getStatusText(item.status)}</span><br>
          <div style="display:flex; justify-content:space-between; margin-top:8px;">
            <div>
              <strong>Cliente:</strong> ${item.customerName}<br>
              <strong>Factura:</strong> ${item.invoiceNumber}
            </div>
            <div style="text-align:right;">
              <strong>Total:</strong> RD$${item.suggestedPrice.toFixed(2)}
            </div>
          </div>
          ${paymentInfo}
          <div class="history-item-buttons">
            <button class="btn-edit" onclick="editInvoiceFromHistory(event, '${doc.id}')">Editar</button>
            <button class="btn-delete" onclick="deleteInvoiceFromHistory(event, '${doc.id}')">Eliminar</button>
          </div>
        `;
        list.appendChild(div);
      });
    } catch (error) {
      console.error("Error loading history:", error);
      list.innerHTML = `<div style="text-align:center; padding:20px; color:#a0aec0;">Error al cargar el historial</div>`;
    }
  }

  function getStatusClass(status) {
    switch(status) {
      case 'design': return 'status-design';
      case 'approval': return 'status-approval';
      case 'preparation': return 'status-preparation';
      case 'printing': return 'status-printing';
      case 'postprocessing': return 'status-postprocessing';
      case 'quality': return 'status-quality';
      case 'delivered': return 'status-delivered';
      case 'paid': return 'status-paid';
      default: return 'status-pending';
    }
  }

  function getStatusText(status) {
    switch(status) {
      case 'design': return 'Diseño';
      case 'approval': return 'Aprobación';
      case 'preparation': return 'Preparación';
      case 'printing': return 'Impresión';
      case 'postprocessing': return 'Post-procesado';
      case 'quality': return 'Control Calidad';
      case 'delivered': return 'Entregado';
      case 'paid': return 'Pagado';
      default: return 'Pendiente';
    }
  }

  function clearForm() {
    document.getElementById("customerName").value = "";
    document.getElementById("electricityPrice").value = "2.80";
    document.getElementById("printHours").value = "6";
    document.getElementById("weight").value = "150";
    document.getElementById("filamentPrice").value = "1600";
    document.getElementById("filamentType").value = "1600";
    document.getElementById("laborCost").value = "150";
    document.getElementById("otherCosts").value = "100";
    document.getElementById("maintenanceCost").value = "50";
    document.getElementById("printerDepreciation").value = "14.00";
    document.getElementById("margin").value = "40";
    document.getElementById("status").value = "design";
    document.getElementById("amountPaid").value = "0";
    document.getElementById("remainingBalance").value = "0";
    document.getElementById('invoiceNumber').value = generateInvoiceNumber();
    calculateResults();
    
    document.getElementById("payment-section").classList.remove("active");
    currentInvoiceId = null;
    alert('Formulario limpiado!');
  }

  async function markAsPaid() {
    const customerName = document.getElementById("customerName").value;
    const invoiceNumber = document.getElementById("invoiceNumber").value;
    
    if (!customerName || !invoiceNumber) {
      alert('Por favor complete los datos del cliente y número de factura');
      return;
    }
    
    try {
      let invoiceDoc;
      
      if (currentInvoiceId) {
        invoiceDoc = await db.collection("invoices").doc(currentInvoiceId).get();
        await db.collection("invoices").doc(currentInvoiceId).update({
          status: 'paid',
          paid: true,
          amountPaid: parseFloat(results.suggestedPrice.textContent) || 0,
          remainingBalance: 0
        });
      } else {
        const invoiceQuery = await db.collection("invoices")
          .where("invoiceNumber", "==", invoiceNumber)
          .limit(1)
          .get();
        
        if (invoiceQuery.empty) {
          alert('No se encontró la factura');
          return;
        }
        
        invoiceDoc = invoiceQuery.docs[0];
        await db.collection("invoices").doc(invoiceDoc.id).update({
          status: 'paid',
          paid: true,
          amountPaid: parseFloat(results.suggestedPrice.textContent) || 0,
          remainingBalance: 0
        });
      }
      
      const customerQuery = await db.collection("customers")
        .where("name", "==", customerName)
        .limit(1)
        .get();
      
      if (!customerQuery.empty) {
        const customerDoc = customerQuery.docs[0];
        const customerData = customerDoc.data();
        const invoiceData = invoiceDoc.data();
        const pendingAmount = (customerData.pendingAmount || 0) - (parseFloat(results.suggestedPrice.textContent) - (invoiceData.amountPaid || 0)) || 0;
        
        await db.collection("customers").doc(customerDoc.id).update({
          pendingAmount: Math.max(0, pendingAmount)
        });
      }
      
      document.getElementById("status").value = "paid";
      document.getElementById("amountPaid").value = parseFloat(results.suggestedPrice.textContent) || 0;
      document.getElementById("remainingBalance").value = 0;
      document.getElementById("payment-section").classList.remove("active");
      
      alert('Factura marcada como pagada!');
      checkAlerts();
    } catch (error) {
      console.error("Error marking as paid:", error);
      alert('Error al marcar como pagada');
    }
  }

  // Funciones del Dashboard
  function openDashboard() {
    document.getElementById("dashboardModal").style.display = "block";
    loadDashboardData();
  }

  function openProjects() {
    document.getElementById("projectsModal").style.display = "block";
    loadProjectsData();
  }

  function openClientPortal() {
    document.getElementById("clientPortalModal").style.display = "block";
    loadClientPortalData();
  }

  function closeModal(modalId) {
    document.getElementById(modalId).style.display = "none";
  }

  function openTab(evt, tabName) {
    const tabContents = document.getElementsByClassName("tab-content");
    for (let i = 0; i < tabContents.length; i++) {
      tabContents[i].classList.remove("active");
    }
    
    const tabs = document.getElementsByClassName("tab");
    for (let i = 0; i < tabs.length; i++) {
      tabs[i].classList.remove("active");
    }
    
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
  }

  function openProjectsTab(evt, tabName) {
    const tabContents = document.querySelectorAll("#projectsModal .tab-content");
    for (let i = 0; i < tabContents.length; i++) {
      tabContents[i].classList.remove("active");
    }
    
    const tabs = document.querySelectorAll("#projectsModal .tab");
    for (let i = 0; i < tabs.length; i++) {
      tabs[i].classList.remove("active");
    }
    
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
  }

  async function loadDashboardData() {
    try {
      const invoicesSnapshot = await db.collection("invoices")
        .orderBy("date", "desc")
        .limit(30)
        .get();
      
      const customersSnapshot = await db.collection("customers")
        .orderBy("lastPurchase", "desc")
        .get();
      
      const templatesSnapshot = await db.collection("templates")
        .orderBy("name")
        .get();
      
      const inventorySnapshot = await db.collection("inventory")
        .orderBy("date", "desc")
        .get();
      
      const invoicesData = invoicesSnapshot.docs.map(doc => doc.data());
      const customersData = customersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const templatesData = templatesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const inventoryData = inventorySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      renderCustomersList(customersData);
      renderTemplatesList(templatesData);
      renderInventoryList(inventoryData);
      renderRecentActivity(invoicesData);
      renderFinancialReports(invoicesData, customersData);
      
      createMonthlyProfitChart(invoicesData);
      createFilamentUsageChart(invoicesData);
      createFilamentMarginChart(invoicesData);
      createCashFlowChart(invoicesData);
      
    } catch (error) {
      console.error("Error loading dashboard data:", error);
    }
  }

  async function loadProjectsData() {
    try {
      const invoicesQuery = await db.collection("invoices")
        .orderBy("date", "desc")
        .get();
      
      const printersQuery = await db.collection("printers")
        .orderBy("name")
        .get();
      
      const invoicesData = invoicesQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const printersData = printersQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      renderProjectStages(invoicesData);
      renderGanttChart(invoicesData);
      renderResourceGrid(printersData, invoicesData);
      createPrinterAvailabilityChart(printersData);
      
    } catch (error) {
      console.error("Error loading projects data:", error);
    }
  }

  async function loadClientPortalData() {
    try {
      const customerName = document.getElementById("customerName").value || "Cliente Demo";
      
      const invoicesQuery = await db.collection("invoices")
        .where("customerName", "==", customerName)
        .orderBy("date", "desc")
        .get();
      
      const invoicesData = invoicesQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      renderClientProjects(invoicesData);
      renderDesignApprovals(invoicesData);
      renderClientInvoices(invoicesData);
      
    } catch (error) {
      console.error("Error loading client portal data:", error);
    }
  }

  function renderProjectStages(projects) {
    const stagesContainer = document.getElementById("project-stages");
    stagesContainer.innerHTML = "";
    
    const stages = [
      { id: 'design', name: 'Diseño' },
      { id: 'approval', name: 'Aprobación' },
      { id: 'preparation', name: 'Preparación' },
      { id: 'printing', name: 'Impresión' },
      { id: 'postprocessing', name: 'Post-procesado' },
      { id: 'quality', name: 'Control Calidad' },
      { id: 'delivered', name: 'Entregado' },
      { id: 'paid', name: 'Pagado' }
    ];
    
    stages.forEach(stage => {
      const stageDiv = document.createElement("div");
      stageDiv.className = "stage";
      
      const stageProjects = projects.filter(p => p.status === stage.id);
      
      let projectsHTML = "";
      stageProjects.forEach(project => {
        projectsHTML += `
          <div class="card" onclick="loadProjectDetails('${project.id}')">
            <strong>${project.customerName}</strong>
            <div>${project.invoiceNumber}</div>
            <div>RD$${project.suggestedPrice?.toFixed(2) || '0.00'}</div>
          </div>
        `;
      });
      
      stageDiv.innerHTML = `
        <div class="stage-title">${stage.name} (${stageProjects.length})</div>
        ${projectsHTML || '<div style="color:#a0aec0; text-align:center;">No hay proyectos</div>'}
      `;
      
      stagesContainer.appendChild(stageDiv);
    });
  }

  function renderGanttChart(projects) {
    const ganttContainer = document.getElementById("gantt-chart");
    ganttContainer.innerHTML = "";
    
    // Convertir proyectos a tareas para el gráfico Gantt
    const tasks = projects.map(project => {
      const startDate = new Date(project.date);
      const endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + 3); // Ejemplo: 3 días de duración
      
      return {
        id: project.id,
        name: `${project.customerName} - ${project.invoiceNumber}`,
        start: startDate.toISOString().split('T')[0],
        end: endDate.toISOString().split('T')[0],
        progress: getProgressByStatus(project.status),
        dependencies: "",
        status: project.status
      };
    });
    
    if (tasks.length > 0) {
      ganttChart = new Gantt("#gantt-chart", tasks, {
        view_mode: 'Day',
        language: 'es',
        on_click: task => loadProjectDetails(task.id)
      });
    } else {
      ganttContainer.innerHTML = '<div style="color:#a0aec0; text-align:center; padding:20px;">No hay proyectos para mostrar</div>';
    }
  }

  function getProgressByStatus(status) {
    switch(status) {
      case 'design': return 10;
      case 'approval': return 20;
      case 'preparation': return 30;
      case 'printing': return 60;
      case 'postprocessing': return 80;
      case 'quality': return 90;
      case 'delivered': return 100;
      case 'paid': return 100;
      default: return 0;
    }
  }

  function renderResourceGrid(printers, projects) {
    const resourceGrid = document.getElementById("resource-grid");
    resourceGrid.innerHTML = "";
    
    printers.forEach(printer => {
      const printerProjects = projects.filter(p => p.printerId === printer.id);
      
      const printerCard = document.createElement("div");
      printerCard.className = "resource-card";
      
      let projectsList = "";
      printerProjects.forEach(project => {
        projectsList += `
          <div style="margin-bottom: 8px;">
            <div>${project.customerName}</div>
            <small>${getStatusText(project.status)}</small>
          </div>
        `;
      });
      
      printerCard.innerHTML = `
        <h4>${printer.name}</h4>
        <div><strong>Tipo:</strong> ${printer.type}</div>
        <div><strong>Estado:</strong> ${printer.status || 'Disponible'}</div>
        <div><strong>Proyectos:</strong> ${printerProjects.length}</div>
        ${projectsList || '<div style="color:#a0aec0; margin-top:10px;">Sin proyectos asignados</div>'}
      `;
      
      resourceGrid.appendChild(printerCard);
    });
  }

  function createPrinterAvailabilityChart(printers) {
    const ctx = document.getElementById('printerAvailabilityChart').getContext('2d');
    
    if (printerAvailabilityChart) {
      printerAvailabilityChart.destroy();
    }
    
    const printerNames = printers.map(p => p.name);
    const printerUsage = printers.map(p => p.status === 'available' ? 0 : 100);
    
    printerAvailabilityChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: printerNames,
        datasets: [{
          label: 'Uso (%)',
          data: printerUsage,
          backgroundColor: 'rgba(255, 159, 67, 0.7)',
          borderColor: 'rgba(255, 159, 67, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Porcentaje de Uso'
            }
          }
        }
      }
    });
  }

  function renderClientProjects(projects) {
    const clientProjects = document.getElementById("client-projects");
    clientProjects.innerHTML = "";
    
    if (projects.length === 0) {
      clientProjects.innerHTML = '<div style="color:#a0aec0; text-align:center; padding:20px;">No hay proyectos registrados</div>';
      return;
    }
    
    projects.forEach(project => {
      const projectDiv = document.createElement("div");
      projectDiv.className = "client-project";
      
      projectDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between;">
          <div>
            <strong>${project.invoiceNumber}</strong>
            <div>${getStatusText(project.status)}</div>
          </div>
          <div style="text-align: right;">
            <div>RD$${project.suggestedPrice?.toFixed(2) || '0.00'}</div>
            <small>${new Date(project.date).toLocaleDateString()}</small>
          </div>
        </div>
        <div style="margin-top: 10px;">
          <button class="btn-save" style="padding: 5px 10px; font-size: 0.8rem;" onclick="viewProjectDetails('${project.id}')">
            Ver Detalles
          </button>
        </div>
      `;
      
      clientProjects.appendChild(projectDiv);
    });
  }

  function renderDesignApprovals(projects) {
    const designApprovals = document.getElementById("design-approvals");
    designApprovals.innerHTML = "";
    
    const approvalProjects = projects.filter(p => p.status === 'approval');
    
    if (approvalProjects.length === 0) {
      designApprovals.innerHTML = '<div style="color:#a0aec0; text-align:center; padding:20px;">No hay diseños pendientes de aprobación</div>';
      return;
    }
    
    approvalProjects.forEach(project => {
      const approvalDiv = document.createElement("div");
      approvalDiv.className = "client-project";
      
      approvalDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between;">
          <div>
            <strong>${project.invoiceNumber}</strong>
            <div>Esperando aprobación</div>
          </div>
          <div style="text-align: right;">
            <small>${new Date(project.date).toLocaleDateString()}</small>
          </div>
        </div>
        <div style="margin-top: 10px; display: flex; gap: 10px;">
          <button class="btn-save" style="padding: 5px 10px; font-size: 0.8rem;" onclick="approveDesign('${project.id}')">
            Aprobar
          </button>
          <button class="btn-clear" style="padding: 5px 10px; font-size: 0.8rem;" onclick="rejectDesign('${project.id}')">
            Rechazar
          </button>
        </div>
      `;
      
      designApprovals.appendChild(approvalDiv);
    });
  }

  function renderClientInvoices(projects) {
    const clientInvoices = document.getElementById("client-invoices");
    clientInvoices.innerHTML = "";
    
    if (projects.length === 0) {
      clientInvoices.innerHTML = '<div style="color:#a0aec0; text-align:center; padding:20px;">No hay facturas registradas</div>';
      return;
    }
    
    projects.forEach(project => {
      const invoiceDiv = document.createElement("div");
      invoiceDiv.className = "client-project";
      
      let paymentInfo = "";
      if (project.amountPaid > 0) {
        paymentInfo = `<div><small>Abonado: RD$${project.amountPaid.toFixed(2)} (Saldo: RD$${project.remainingBalance.toFixed(2)})</small></div>`;
      }
      
      invoiceDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between;">
          <div>
            <strong>${project.invoiceNumber}</strong>
            <div>${getStatusText(project.status)}</div>
            ${paymentInfo}
          </div>
          <div style="text-align: right;">
            <div>RD$${project.suggestedPrice?.toFixed(2) || '0.00'}</div>
            <small>${new Date(project.date).toLocaleDateString()}</small>
          </div>
        </div>
        <div style="margin-top: 10px;">
          <button class="btn-export" style="padding: 5px 10px; font-size: 0.8rem;" onclick="downloadClientInvoice('${project.id}')">
            Descargar Factura
          </button>
        </div>
      `;
      
      clientInvoices.appendChild(invoiceDiv);
    });
  }

  function createMonthlyProfitChart(invoices) {
    const monthlyData = {};
    invoices.forEach(invoice => {
      const date = new Date(invoice.date);
      const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
      
      if (!monthlyData[monthYear]) {
        monthlyData[monthYear] = 0;
      }
      
      monthlyData[monthYear] += invoice.suggestedPrice - invoice.totalCost;
    });
    
    const labels = Object.keys(monthlyData).sort();
    const data = labels.map(label => monthlyData[label]);
    
    const ctx = document.getElementById('monthlyProfitChart').getContext('2d');
    
    if (monthlyProfitChart) {
      monthlyProfitChart.destroy();
    }
    
    monthlyProfitChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Ganancias',
          data: data,
          backgroundColor: 'rgba(255, 159, 67, 0.7)',
          borderColor: 'rgba(255, 159, 67, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'RD$'
            }
          }
        }
      }
    });
  }

  function createFilamentUsageChart(invoices) {
    const filamentData = {
      "PLA": 0,
      "PETG": 0,
      "ABS": 0,
      "ASA": 0,
      "Personalizado": 0
    };
    
    invoices.forEach(invoice => {
      const filamentPrice = invoice.filamentPrice || 1600;
      let type;
      
      if (filamentPrice === 1600) type = "PLA";
      else if (filamentPrice === 2000) type = "PETG";
      else if (filamentPrice === 2250) type = "ABS";
      else if (filamentPrice === 2150) type = "ASA";
      else type = "Personalizado";
      
      filamentData[type] += (invoice.weight || 0) / 1000;
    });
    
    const labels = Object.keys(filamentData);
    const data = Object.values(filamentData);
    
    const ctx = document.getElementById('filamentUsageChart').getContext('2d');
    
    if (filamentUsageChart) {
      filamentUsageChart.destroy();
    }
    
    filamentUsageChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: [
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 99, 132, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 206, 86, 0.7)'
          ],
          borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(255, 99, 132, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 206, 86, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right' },
          tooltip: {
            callbacks: {
              label: context => `${context.label}: ${context.raw.toFixed(2)} kg`
            }
          }
        }
      }
    });
  }

  function createFilamentMarginChart(invoices) {
    const margins = calculateMarginsByFilament(invoices);
    const labels = Object.keys(margins);
    const data = Object.values(margins);
    
    const ctx = document.getElementById('filamentMarginChart').getContext('2d');
    
    if (filamentMarginChart) {
      filamentMarginChart.destroy();
    }
    
    filamentMarginChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Margen (%)',
          data: data,
          backgroundColor: 'rgba(75, 192, 192, 0.7)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Porcentaje de Margen'
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              afterLabel: context => {
                const filamentType = context.label;
                const margin = context.raw;
                let recommendation = "";
                
                if (margin < 20) {
                  recommendation = "Considera aumentar el precio o reducir costos";
                } else if (margin > 50) {
                  recommendation = "Margen saludable";
                } else {
                  recommendation = "Margen aceptable";
                }
                
                return `Recomendación: ${recommendation}`;
              }
            }
          }
        }
      }
    });
  }

  function createCashFlowChart(invoices) {
    const now = new Date();
    const months = [];
    for (let i = 0; i < 6; i++) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      months.unshift(`${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`);
    }
    
    const cashFlowData = months.map(month => {
      const monthInvoices = invoices.filter(inv => {
        const invDate = new Date(inv.date);
        return `${invDate.getFullYear()}-${(invDate.getMonth() + 1).toString().padStart(2, '0')}` === month;
      });
      
      const income = monthInvoices.reduce((sum, inv) => sum + (inv.paid ? inv.suggestedPrice : 0), 0);
      const expenses = monthInvoices.reduce((sum, inv) => sum + inv.totalCost, 0);
      
      return income - expenses;
    });
    
    const ctx = document.getElementById('cashFlowChart').getContext('2d');
    
    if (cashFlowChart) {
      cashFlowChart.destroy();
    }
    
    cashFlowChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [
          {
            label: 'Flujo de Caja',
            data: cashFlowData,
            borderColor: 'rgba(255, 159, 67, 1)',
            backgroundColor: 'rgba(255, 159, 67, 0.1)',
            fill: true,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: 'RD$'
            }
          }
        }
      }
    });
  }

  function calculateMarginsByFilament(invoices) {
    const margins = {
      "PLA": { totalCost: 0, totalPrice: 0 },
      "PETG": { totalCost: 0, totalPrice: 0 },
      "ABS": { totalCost: 0, totalPrice: 0 },
      "ASA": { totalCost: 0, totalPrice: 0 },
      "Personalizado": { totalCost: 0, totalPrice: 0 }
    };
    
    invoices.forEach(invoice => {
      const filamentPrice = invoice.filamentPrice || 1600;
      let type;
      
      if (filamentPrice === 1600) type = "PLA";
      else if (filamentPrice === 2000) type = "PETG";
      else if (filamentPrice === 2250) type = "ABS";
      else if (filamentPrice === 2150) type = "ASA";
      else type = "Personalizado";
      
      margins[type].totalCost += invoice.totalCost || 0;
      margins[type].totalPrice += invoice.suggestedPrice || 0;
    });
    
    const result = {};
    for (const [type, data] of Object.entries(margins)) {
      if (data.totalCost > 0) {
        result[type] = ((data.totalPrice - data.totalCost) / data.totalCost) * 100;
      } else {
        result[type] = 0;
      }
    }
    
    return result;
  }

  // Funciones de WhatsApp
  function openWhatsAppModal(invoiceId = null) {
    document.getElementById("whatsappModal").style.display = "block";
    currentWhatsAppTemplate = null;
    
    if (invoiceId) {
      loadInvoiceForWhatsApp(invoiceId);
    } else {
      updateWhatsAppMessage();
    }
  }

  function updateWhatsAppMessage(invoiceData = null) {
    const customerName = invoiceData?.customerName || document.getElementById("customerName").value || "Cliente";
    const invoiceNumber = invoiceData?.invoiceNumber || document.getElementById("invoiceNumber").value || "FAC-00000";
    const totalPrice = invoiceData?.suggestedPrice?.toFixed(2) || results.customerTotalPrice.textContent || "0.00";
    const remainingBalance = invoiceData?.remainingBalance?.toFixed(2) || document.getElementById("remainingBalance").value || "0.00";
    const status = invoiceData?.status || document.getElementById("status").value;
    
    let message = "";
    
    if (currentWhatsAppTemplate) {
      switch(currentWhatsAppTemplate) {
        case 'invoice':
          message = `Hola ${customerName}, tu factura #${invoiceNumber} está lista. Total: RD$${totalPrice}. ¿Necesitas alguna aclaración?`;
          break;
        case 'printing':
          message = `Hola ${customerName}, tu pedido #${invoiceNumber} está en proceso de impresión. Te mantendremos informado.`;
          break;
        case 'completed':
          message = `Hola ${customerName}, tu pedido #${invoiceNumber} está terminado. ¿Cuándo podrás recogerlo?`;
          break;
        case 'delivered':
          message = `Hola ${customerName}, tu pedido #${invoiceNumber} ha sido entregado. ¡Gracias por confiar en nosotros!`;
          break;
        case 'payment':
          message = `Hola ${customerName}, recuerda que tienes un saldo pendiente de RD$${remainingBalance} en la factura #${invoiceNumber}. ¿Necesitas alguna aclaración?`;
          break;
        case 'feedback':
          message = `Hola ${customerName}, ¿cómo ha sido tu experiencia con nuestro servicio? Agradecemos tus comentarios.`;
          break;
        default:
          message = `Hola ${customerName}, tu factura #${invoiceNumber} está lista. Total: RD$${totalPrice}. ¿Necesitas alguna aclaración?`;
      }
    } else {
      switch(status) {
        case 'design': 
          message = `Hola ${customerName}, estamos trabajando en el diseño de tu proyecto. ¿Tienes algún requerimiento especial?`;
          break;
        case 'approval':
          message = `Hola ${customerName}, tenemos el diseño listo para tu aprobación. ¿Cuándo podemos revisarlo juntos?`;
          break;
        case 'printing':
          message = `Hola ${customerName}, tu pedido #${invoiceNumber} está en proceso de impresión. Te mantendremos informado.`;
          break;
        case 'quality':
          message = `Hola ${customerName}, tu pedido #${invoiceNumber} está en control de calidad. Pronto estará listo para entrega.`;
          break;
        case 'paid':
          message = `Hola ${customerName}, ¿cómo ha sido tu experiencia con nuestro servicio? Agradecemos tus comentarios.`;
          break;
        default:
          message = `Hola ${customerName}, tu factura #${invoiceNumber} está lista. Total: RD$${totalPrice}. ¿Necesitas alguna aclaración?`;
      }
    }
    
    const messagePreview = document.getElementById("whatsapp-message-preview");
    messagePreview.innerHTML = message.replace(/\n/g, "<br>");
  }

  function sendWhatsAppMessage() {
    const messagePreview = document.getElementById("whatsapp-message-preview");
    const text = messagePreview.textContent || messagePreview.innerText;
    const phoneNumber = "18493615653";
    
    const encodedMessage = encodeURIComponent(text);
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
    
    window.open(whatsappUrl, '_blank');
    alert("Mensaje preparado para WhatsApp");
    closeModal("whatsappModal");
  }

  // Inicialización
  window.onload = async function() {
    calculateResults();
    await renderHistory();
    await loadCustomersForAutocomplete();
    await checkAlerts();
    
    document.querySelectorAll("input").forEach(input => {
      if (input.id !== "amountPaid") {
        input.addEventListener("input", calculateResults);
      }
    });
    
    document.getElementById("filamentPrice").addEventListener("input", function() {
      if (this.value !== document.getElementById("filamentType").value) {
        document.getElementById("filamentType").value = "custom";
      }
    });
  };

  // Funciones auxiliares
  async function loadCustomersForAutocomplete() {
    try {
      const querySnapshot = await db.collection("customers").orderBy("name").get();
      const datalist = document.getElementById("customersList");
      datalist.innerHTML = "";
      
      querySnapshot.forEach(doc => {
        const customer = doc.data();
        const option = document.createElement("option");
        option.value = customer.name;
        datalist.appendChild(option);
      });
    } catch (error) {
      console.error("Error loading customers:", error);
    }
  }

  function searchCustomers() {
    const searchTerm = document.getElementById("customerSearch").value.toLowerCase();
    const customers = document.querySelectorAll("#customers-list .card");
    
    customers.forEach(customer => {
      const name = customer.querySelector("h3").textContent.toLowerCase();
      customer.style.display = name.includes(searchTerm) ? "block" : "none";
    });
  }

  function searchTemplates() {
    const searchTerm = document.getElementById("templateSearch").value.toLowerCase();
    const templates = document.querySelectorAll("#templates-list .card");
    
    templates.forEach(template => {
      const name = template.querySelector("h3").textContent.toLowerCase();
      template.style.display = name.includes(searchTerm) ? "block" : "none";
    });
  }

  async function checkAlerts() {
    const alertsContainer = document.getElementById("alerts-container");
    alertsContainer.innerHTML = "";
    
    try {
      // Verificar pagos pendientes
      const pendingQuery = await db.collection("invoices")
        .where("paid", "==", false)
        .get();
      
      const pendingAmount = pendingQuery.docs.reduce((sum, doc) => {
        const data = doc.data();
        return sum + (data.remainingBalance || data.suggestedPrice || 0);
      }, 0);
      
      if (pendingAmount > 0) {
        const alertDiv = document.createElement("div");
        alertDiv.className = "alert-banner warning";
        alertDiv.innerHTML = `
          <span>Tienes ${pendingQuery.size} facturas pendientes por un total de RD$${pendingAmount.toFixed(2)}</span>
          <button class="btn-payment" style="padding: 5px 10px; font-size: 0.8rem;" onclick="openDashboard(); openTab(event, 'reports-tab')">Ver detalles</button>
        `;
        alertsContainer.appendChild(alertDiv);
      }
      
      // Verificar inventario bajo
      const inventoryQuery = await db.collection("inventory")
        .orderBy("date", "desc")
        .get();
      
      const lowInventory = [];
      inventoryQuery.forEach(doc => {
        const item = doc.data();
        if (item.remaining < 0.5) {
          lowInventory.push(item);
        }
      });
      
      if (lowInventory.length > 0) {
        const alertDiv = document.createElement("div");
        alertDiv.className = "alert-banner info";
        alertDiv.innerHTML = `
          <span>Bajo inventario: ${lowInventory.map(item => `${item.type} (${item.remaining.toFixed(2)}kg`).join(', ')}</span>
          <button class="btn-save" style="padding: 5px 10px; font-size: 0.8rem;" onclick="openDashboard(); openTab(event, 'inventory-tab')">Reponer</button>
        `;
        alertsContainer.appendChild(alertDiv);
      }
      
      // Verificar márgenes bajos por tipo de filamento
      const marginAlerts = await checkFilamentMargins();
      if (marginAlerts.length > 0) {
        const alertDiv = document.createElement("div");
        alertDiv.className = "alert-banner warning";
        alertDiv.innerHTML = `
          <span>Alertas de margen: ${marginAlerts.join(', ')}</span>
          <button class="btn-dashboard" style="padding: 5px 10px; font-size: 0.8rem;" onclick="openDashboard(); openTab(event, 'stats-tab')">Ver detalles</button>
        `;
        alertsContainer.appendChild(alertDiv);
      }
      
    } catch (error) {
      console.error("Error checking alerts:", error);
    }
  }

  async function checkFilamentMargins() {
    try {
      const now = new Date();
      
      const invoicesQuery = await db.collection("invoices")
        .where("date", ">=", new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString())
        .get();
      
      const margins = calculateMarginsByFilament(invoicesQuery.docs.map(doc => doc.data()));
      const alerts = [];
      
      for (const [filamentType, margin] of Object.entries(margins)) {
        if (margin < 20) {
          alerts.push(`${filamentType} (${margin.toFixed(1)}%)`);
        }
      }
      
      return alerts;
    } catch (error) {
      console.error("Error checking filament margins:", error);
      return [];
    }
  }

  // Funciones de gestión de proyectos
  async function loadProjectDetails(projectId) {
    try {
      const doc = await db.collection("invoices").doc(projectId).get();
      if (doc.exists) {
        const data = doc.data();
        loadInvoiceFromHistory(projectId, data);
        closeModal("projectsModal");
      }
    } catch (error) {
      console.error("Error loading project details:", error);
    }
  }

  async function viewProjectDetails(projectId) {
    try {
      const doc = await db.collection("invoices").doc(projectId).get();
      if (doc.exists) {
        const data = doc.data();
        alert(`Detalles del proyecto:\n\nCliente: ${data.customerName}\nFactura: ${data.invoiceNumber}\nEstado: ${getStatusText(data.status)}\nTotal: RD$${data.suggestedPrice?.toFixed(2) || '0.00'}`);
      }
    } catch (error) {
      console.error("Error viewing project details:", error);
    }
  }

  async function approveDesign(projectId) {
    try {
      await db.collection("invoices").doc(projectId).update({
        status: 'preparation'
      });
      alert('Diseño aprobado correctamente');
      loadClientPortalData();
    } catch (error) {
      console.error("Error approving design:", error);
      alert('Error al aprobar el diseño');
    }
  }

  async function rejectDesign(projectId) {
    const feedback = prompt("Por favor, indique los cambios necesarios:");
    if (feedback === null) return;
    
    try {
      await db.collection("invoices").doc(projectId).update({
        status: 'design',
        feedback: feedback
      });
      alert('Diseño rechazado. Se ha enviado el feedback al equipo.');
      loadClientPortalData();
    } catch (error) {
      console.error("Error rejecting design:", error);
      alert('Error al rechazar el diseño');
    }
  }

  async function downloadClientInvoice(projectId) {
    try {
      const doc = await db.collection("invoices").doc(projectId).get();
      if (doc.exists) {
        const data = doc.data();
        
        // Simular generación de PDF
        alert(`Preparando descarga de factura ${data.invoiceNumber} para ${data.customerName}`);
      }
    } catch (error) {
      console.error("Error downloading invoice:", error);
      alert('Error al descargar la factura');
    }
  }

  // Función para cargar factura desde historial
  async function loadInvoiceFromHistory(docId) {
    try {
      const doc = await db.collection("invoices").doc(docId).get();
      if (doc.exists) {
        const data = doc.data();
        
        currentInvoiceId = docId;
        
        document.getElementById("customerName").value = data.customerName;
        document.getElementById("electricityPrice").value = data.electricityPrice;
        document.getElementById("printHours").value = data.printHours;
        document.getElementById("weight").value = data.weight;
        document.getElementById("filamentPrice").value = data.filamentPrice;
        document.getElementById("filamentType").value = data.filamentType || "1600";
        document.getElementById("laborCost").value = data.laborCost;
        document.getElementById("otherCosts").value = data.otherCosts;
        document.getElementById("maintenanceCost").value = data.maintenanceCost || 0;
        document.getElementById("printerDepreciation").value = data.printerDepreciation || 14.00;
        document.getElementById("margin").value = data.margin;
        document.getElementById("invoiceNumber").value = data.invoiceNumber;
        document.getElementById("status").value = data.status || "design";
        document.getElementById("amountPaid").value = data.amountPaid || 0;
        document.getElementById("remainingBalance").value = data.remainingBalance || 0;
        
        togglePaymentSection();
        calculateResults();
      }
    } catch (error) {
      console.error("Error loading invoice:", error);
    }
  }
</script>
</body>
</html>