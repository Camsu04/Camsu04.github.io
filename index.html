<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Factura 3DCraftRD</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a202c, #2d3748);
      color: white;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 900px;
      width: 100%;
      background-color: #2d3748;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      padding: 30px;
      border: 1px solid #4a5568;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #ff9f43;
      gap: 20px;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header img {
      width: 60px;
      height: auto;
    }

    .brand-name {
      font-size: 2.5rem;
      font-weight: bold;
      color: #ff9f43;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    h1 {
      margin: 0;
      font-size: 2.2rem;
      color: white;
      text-align: center;
    }

    form input[type="number"],
    form input[type="text"],
    form select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #4a5568;
      border-radius: 8px;
      margin-top: 5px;
      background-color: #3c4758;
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    form input[type="number"]:focus,
    form input[type="text"]:focus,
    form select:focus {
      outline: none;
      border-color: #ff9f43;
      box-shadow: 0 0 0 3px rgba(255, 159, 67, 0.2);
    }

    label {
      display: block;
      margin-top: 18px;
      font-weight: 600;
      color: #e2e8f0;
    }

    .results {
      margin-top: 30px;
      background-color: #3c4758;
      padding: 25px;
      border-radius: 10px;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
    }

    .results div {
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #4a5568;
    }

    .results h3 {
      margin-top: 0;
      padding-bottom: 15px;
      margin-bottom: 15px;
      border-bottom: 2px solid #ff9f43;
      color: #ff9f43;
      font-size: 1.4rem;
    }

    .customer-results {
      background: linear-gradient(to right, #2c5282, #2a4365);
      border-left: 5px solid #ff9f43;
    }

    .customer-results div:last-child {
      border-bottom: none;
      font-weight: bold;
      font-size: 1.2rem;
      padding-top: 15px;
      color: #ff9f43;
    }

    .btn-export,
    .btn-clear,
    .btn-save,
    .btn-lang,
    .btn-dashboard,
    .btn-template,
    .btn-payment,
    .btn-workflow,
    .btn-whatsapp,
    .btn-notify {
      display: inline-block;
      margin-top: 10px;
      margin-right: 10px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    .btn-export {
      background: linear-gradient(to right, #4CAF50, #2E7D32);
      color: white;
    }

    .btn-save {
      background: linear-gradient(to right, #2196F3, #0D47A1);
      color: white;
    }

    .btn-clear {
      background: linear-gradient(to right, #f44336, #b71c1c);
      color: white;
    }

    .btn-lang {
      background: linear-gradient(to right, #9C27B0, #6A1B9A);
      color: white;
    }

    .btn-dashboard {
      background: linear-gradient(to right, #FF9800, #F57C00);
      color: white;
    }

    .btn-template {
      background: linear-gradient(to right, #607D8B, #455A64);
      color: white;
    }

    .btn-payment {
      background: linear-gradient(to right, #FFC107, #FFA000);
      color: white;
    }

    .btn-workflow {
      background: linear-gradient(to right, #00BCD4, #0097A7);
      color: white;
    }

    .btn-whatsapp {
      background: linear-gradient(to right, #25D366, #128C7E);
      color: white;
    }

    .btn-notify {
      background: linear-gradient(to right, #34B7F1, #1DA1F2);
      color: white;
    }

    .btn-export:hover,
    .btn-save:hover,
    .btn-clear:hover,
    .btn-lang:hover,
    .btn-dashboard:hover,
    .btn-template:hover,
    .btn-payment:hover,
    .btn-workflow:hover,
    .btn-whatsapp:hover,
    .btn-notify:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
    }

    .history {
      margin-top: 30px;
      background-color: #3c4758;
      padding: 20px;
      border-radius: 10px;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
    }

    .history-item {
      margin-bottom: 12px;
      padding: 15px;
      border-radius: 8px;
      background-color: #2d3748;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .history-item:hover {
      background-color: #4a5568;
      transform: translateX(5px);
    }
    
    .invoice-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 20px;
      padding: 20px;
      background-color: #3c4758;
      border-radius: 10px;
    }
    
    .invoice-header div {
      flex: 1;
      min-width: 250px;
    }
    
    .section-title {
      color: #ff9f43;
      margin-top: 25px;
      margin-bottom: 10px;
      font-size: 1.3rem;
      padding-left: 10px;
      border-left: 4px solid #ff9f43;
    }

    .buttons-container {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 30px;
      justify-content: center;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      overflow: auto;
    }

    .modal-content {
      background-color: #2d3748;
      margin: 5% auto;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      width: 80%;
      max-width: 900px;
      border: 1px solid #4a5568;
      position: relative;
    }

    .close {
      position: absolute;
      right: 25px;
      top: 15px;
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: white;
    }

    .chart-container {
      margin-top: 20px;
      height: 400px;
      background-color: #3c4758;
      border-radius: 8px;
      padding: 15px;
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #4a5568;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background-color: #3c4758;
      border: none;
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .tab.active {
      background-color: #4a5568;
      color: #ff9f43;
      border-bottom: 3px solid #ff9f43;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .customer-card {
      background-color: #3c4758;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .customer-card:hover {
      background-color: #4a5568;
      transform: translateY(-3px);
    }

    .template-card {
      background-color: #3c4758;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .template-card:hover {
      background-color: #4a5568;
      transform: translateY(-3px);
    }

    .inventory-card {
      background-color: #3c4758;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .inventory-card:hover {
      background-color: #4a5568;
      transform: translateY(-3px);
    }

    .workflow-card {
      background-color: #3c4758;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .workflow-card:hover {
      background-color: #4a5568;
      transform: translateY(-3px);
    }

    .search-box {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #4a5568;
      border-radius: 8px;
      margin-bottom: 20px;
      background-color: #3c4758;
      color: white;
      font-size: 1rem;
    }

    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
      margin-left: 8px;
    }

    .status-received {
      background-color: #FF9800;
      color: #fff;
    }

    .status-printing {
      background-color: #2196F3;
      color: #fff;
    }

    .status-completed {
      background-color: #4CAF50;
      color: #fff;
    }

    .status-delivered {
      background-color: #9C27B0;
      color: #fff;
    }

    .status-paid {
      background-color: #607D8B;
      color: #fff;
    }

    .status-pending {
      background-color: #f44336;
      color: #fff;
    }

    .alert-banner {
      background-color: #f44336;
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
      100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
    }

    .alert-banner.warning {
      background-color: #FF9800;
    }

    .alert-banner.info {
      background-color: #2196F3;
    }

    .alert-banner.success {
      background-color: #4CAF50;
    }

    .history-item-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .history-item-buttons button {
      padding: 5px 10px;
      font-size: 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-edit {
      background-color: #2196F3;
      color: white;
    }

    .btn-delete {
      background-color: #f44336;
      color: white;
    }

    .payment-section {
      margin-top: 20px;
      padding: 15px;
      background-color: #3c4758;
      border-radius: 8px;
      display: none;
    }

    .payment-section.active {
      display: block;
    }

    .checklist-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background-color: #3c4758;
      border-radius: 8px;
    }

    .checklist-item input[type="checkbox"] {
      margin-right: 10px;
    }

    .checklist-item label {
      margin: 0;
      flex-grow: 1;
    }

    .task-assignment {
      margin-top: 15px;
      padding: 15px;
      background-color: #3c4758;
      border-radius: 8px;
    }

    .task-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 10px;
      background-color: #2d3748;
      border-radius: 6px;
    }

    .whatsapp-modal-content {
      max-width: 500px;
    }

    .whatsapp-message {
      background-color: #ECE5DD;
      color: #000;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    .whatsapp-templates {
      margin-top: 15px;
    }

    .whatsapp-template {
      padding: 10px;
      margin-bottom: 10px;
      background-color: #3c4758;
      border-radius: 8px;
      cursor: pointer;
    }

    .whatsapp-template:hover {
      background-color: #4a5568;
    }

    @media (max-width: 600px) {
      .header {
        flex-direction: column;
        text-align: center;
      }
      
      .logo-container {
        justify-content: center;
      }
      
      .invoice-header {
        flex-direction: column;
      }
      
      .buttons-container {
        flex-direction: column;
      }
      
      .modal-content {
        width: 95%;
        margin: 10% auto;
        padding: 15px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="logo-container">
      <img src="logo.png" alt="Logo 3DCraftRD" />
      <div class="brand-name">3DCraftRD</div>
    </div>
    <h1 id="app-title">Factura</h1>
  </div>

  <div style="text-align:right; margin-bottom:15px;">
    <button class="btn-lang" onclick="toggleLang()" id="btn-lang">Toggle Language</button>
    <button class="btn-dashboard" onclick="openDashboard()" id="btn-dashboard">Dashboard</button>
    <button class="btn-workflow" onclick="openWorkflow()" id="btn-workflow">Flujo de Trabajo</button>
  </div>

  <div id="alerts-container"></div>

  <div class="invoice-header">
    <div>
      <label for="customerName" id="lbl-customer-name">Nombre del Cliente</label>
      <input type="text" id="customerName" placeholder="Ingrese el nombre del cliente" list="customersList" />
      <datalist id="customersList"></datalist>
    </div>
    <div>
      <label for="invoiceNumber" id="lbl-invoice-number">Número de Factura</label>
      <input type="text" id="invoiceNumber" readonly />
    </div>
    <div>
      <label for="status" id="lbl-status">Estado del Pedido</label>
      <select id="status" onchange="togglePaymentSection()">
        <option value="received">Recibido</option>
        <option value="printing">En impresión</option>
        <option value="completed">Terminado</option>
        <option value="delivered">Entregado</option>
        <option value="paid">Pagado</option>
      </select>
    </div>
  </div>

  <div id="payment-section" class="payment-section">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      <div>
        <label for="amountPaid" id="lbl-amount-paid">Monto Abonado (RD$)</label>
        <input type="number" id="amountPaid" value="0" min="0" />
      </div>
      <div>
        <label for="remainingBalance" id="lbl-remaining-balance">Saldo Pendiente (RD$)</label>
        <input type="number" id="remainingBalance" value="0" readonly />
      </div>
    </div>
  </div>

  <form id="calculator-form">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      <div>
        <label for="filamentType" id="lbl-filament-type">Tipo de Filamento</label>
        <select id="filamentType">
          <option value="1600">PLA (RD$1,600/kg)</option>
          <option value="2000">PETG (RD$2,000/kg)</option>
          <option value="2250">ABS (RD$2,250/kg)</option>
          <option value="2150">ASA (RD$2,150/kg)</option>
          <option value="custom">Personalizado</option>
        </select>

        <label for="filamentPrice" id="lbl-filament-price">Precio del filamento (RD$/kg)</label>
        <input type="number" id="filamentPrice" value="1600" />

        <label for="weight" id="lbl-weight">Peso del modelo (g)</label>
        <input type="number" id="weight" value="150" />

        <label for="electricityPrice" id="lbl-electricity-price">Precio de la electricidad (RD$/kWh)</label>
        <input type="number" step="0.01" id="electricityPrice" value="2.80" />

        <label for="printHours" id="lbl-print-hours">Horas de impresión</label>
        <input type="number" id="printHours" value="6" />
      </div>
      
      <div>
        <label for="laborCost" id="lbl-labor-cost">Mano de obra (RD$)</label>
        <input type="number" id="laborCost" value="150" />

        <label for="otherCosts" id="lbl-other-costs">Otros costos (RD$)</label>
        <input type="number" id="otherCosts" value="100" />

        <label for="maintenanceCost" id="lbl-maintenance-cost">Costo de mantenimiento (RD$)</label>
        <input type="number" id="maintenanceCost" value="50" />

        <label for="printerDepreciation" id="lbl-printer-depreciation">Depreciación de impresora (RD$/hora)</label>
        <input type="number" step="0.01" id="printerDepreciation" value="14.00" />

        <label for="margin" id="lbl-margin">Margen de ganancia (%)</label>
        <input type="number" id="margin" value="40" />

        <label for="exchangeRate" id="lbl-exchange-rate">Tasa de cambio USD a RD$</label>
        <input type="number" id="exchangeRate" value="58.00" />
      </div>
    </div>
  </form>

  <div class="section-title" id="lbl-admin-results">Resultados (Administrador)</div>
  <div class="results">
    <div><span id="lbl-material-cost">Costo del material:</span> <span>RD$<span id="materialCost">0.00</span></span></div>
    <div><span id="lbl-energy-cost">Costo de energía eléctrica:</span> <span>RD$<span id="energyCost">0.00</span></span></div>
    <div><span id="lbl-printing-cost">Costo de impresión:</span> <span>RD$<span id="printingCost">0.00</span></span></div>
    <div><span id="lbl-maintenance-cost-admin">Costo de mantenimiento:</span> <span>RD$<span id="maintenanceCostAdmin">0.00</span></span></div>
    <div><span id="lbl-labor-cost-admin">Costo de mano de obra:</span> <span>RD$<span id="laborCostAdmin">0.00</span></span></div>
    <div><span id="lbl-other-costs-admin">Otros costos:</span> <span>RD$<span id="otherCostsAdmin">0.00</span></span></div>
    <div><span id="lbl-total-cost">Costo total:</span> <span>RD$<span id="totalCost">0.00</span></span></div>
    <div><span id="lbl-suggested-price">Precio sugerido:</span> <span>RD$<span id="suggestedPrice">0.00</span></span></div>
    <div><span id="lbl-net-profit">Ganancia neta:</span> <span>RD$<span id="netProfit">0.00</span></span></div>
  </div>

  <div class="section-title" id="lbl-customer-results">Detalles de la Factura (Cliente)</div>
  <div class="results customer-results">
    <div><span id="lbl-customer-material-cost">Materiales utilizados:</span> <span>RD$<span id="customerMaterialCost">0.00</span></span></div>
    <div><span id="lbl-customer-energy-cost">Consumo energético:</span> <span>RD$<span id="customerEnergyCost">0.00</span></span></div>
    <div><span id="lbl-customer-printing-cost">Tiempo de máquina:</span> <span>RD$<span id="customerPrintingCost">0.00</span></span></div>
    <div><span id="lbl-customer-service-cost">Servicio técnico:</span> <span>RD$<span id="customerServiceCost">0.00</span></span></div>
    <div><span id="lbl-customer-total-price">Precio Total:</span> <span>RD$<span id="customerTotalPrice">0.00</span></span></div>
  </div>

  <div class="buttons-container">
    <button class="btn-export" onclick="exportToPDF()" id="btn-export">Exportar a PDF</button>
    <button class="btn-save" onclick="saveToHistory()" id="btn-save">Guardar en Historial</button>
    <button class="btn-clear" onclick="clearForm()" id="btn-clear">Limpiar Formulario</button>
    <button class="btn-template" onclick="saveTemplate()" id="btn-template">Guardar Plantilla</button>
    <button class="btn-payment" onclick="markAsPaid()" id="btn-payment">Marcar como Pagado</button>
    <button class="btn-whatsapp" onclick="openWhatsAppModal()" id="btn-whatsapp">Enviar por WhatsApp</button>
    <button class="btn-notify" onclick="sendStatusNotification()" id="btn-notify">Notificar Estado</button>
  </div>

  <div class="history" id="history-section">
    <h3 id="lbl-history">Historial de Impresiones</h3>
    <div id="history-list"></div>
  </div>
</div>

<!-- Modal Dashboard -->
<div id="dashboardModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('dashboardModal')">&times;</span>
    <h2 id="lbl-dashboard-title">Dashboard Analytics</h2>
    
    <div class="tabs">
      <button class="tab active" onclick="openTab(event, 'stats-tab')" id="tab-stats">Estadísticas</button>
      <button class="tab" onclick="openTab(event, 'customers-tab')" id="tab-customers">Clientes</button>
      <button class="tab" onclick="openTab(event, 'templates-tab')" id="tab-templates">Plantillas</button>
      <button class="tab" onclick="openTab(event, 'inventory-tab')" id="tab-inventory">Inventario</button>
      <button class="tab" onclick="openTab(event, 'reports-tab')" id="tab-reports">Reportes</button>
    </div>
    
    <div id="stats-tab" class="tab-content active">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <h3 id="lbl-monthly-profit">Ganancias Mensuales</h3>
          <div class="chart-container">
            <canvas id="monthlyProfitChart"></canvas>
          </div>
        </div>
        <div>
          <h3 id="lbl-filament-usage">Uso de Filamento</h3>
          <div class="chart-container">
            <canvas id="filamentUsageChart"></canvas>
          </div>
        </div>
      </div>
      <div style="margin-top: 20px;">
        <h3 id="lbl-recent-activity">Actividad Reciente</h3>
        <div id="recent-activity" style="max-height: 300px; overflow-y: auto;"></div>
      </div>
    </div>
    
    <div id="customers-tab" class="tab-content">
      <input type="text" id="customerSearch" class="search-box" placeholder="Buscar clientes..." oninput="searchCustomers()" />
      <div id="customers-list"></div>
    </div>
    
    <div id="templates-tab" class="tab-content">
      <input type="text" id="templateSearch" class="search-box" placeholder="Buscar plantillas..." oninput="searchTemplates()" />
      <div id="templates-list"></div>
    </div>
    
    <div id="inventory-tab" class="tab-content">
      <h3 id="lbl-inventory">Inventario de Filamento</h3>
      <div id="inventory-list"></div>
      
      <h3 style="margin-top: 30px;" id="lbl-add-inventory">Agregar al Inventario</h3>
      <form id="inventory-form">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div>
            <label for="inv-filament-type" id="lbl-inv-filament-type">Tipo de Filamento</label>
            <select id="inv-filament-type">
              <option value="PLA">PLA</option>
              <option value="PETG">PETG</option>
              <option value="ABS">ABS</option>
              <option value="ASA">ASA</option>
              <option value="Otro">Otro</option>
            </select>
            
            <label for="inv-color" id="lbl-inv-color">Color</label>
            <input type="text" id="inv-color" placeholder="Ej: Negro, Blanco, etc." />
          </div>
          <div>
            <label for="inv-quantity" id="lbl-inv-quantity">Cantidad (kg)</label>
            <input type="number" step="0.01" id="inv-quantity" value="1.00" />
            
            <label for="inv-price" id="lbl-inv-price">Precio por kg (RD$)</label>
            <input type="number" id="inv-price" value="1600" />
          </div>
        </div>
        <button type="button" class="btn-save" style="margin-top: 15px;" onclick="addToInventory()" id="btn-add-inventory">Agregar al Inventario</button>
      </form>
    </div>
    
    <div id="reports-tab" class="tab-content">
      <h3 id="lbl-pending-payments">Pagos Pendientes</h3>
      <div id="pending-payments-list"></div>
      
      <h3 style="margin-top: 30px;" id="lbl-financial-summary">Resumen Financiero</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="results">
          <div><span id="lbl-total-sales">Ventas Totales:</span> <span>RD$<span id="total-sales">0.00</span></span></div>
          <div><span id="lbl-total-pending">Total Pendiente:</span> <span>RD$<span id="total-pending">0.00</span></span></div>
          <div><span id="lbl-total-costs">Costos Totales:</span> <span>RD$<span id="total-costs">0.00</span></span></div>
        </div>
        <div class="results">
          <div><span id="lbl-total-profit">Ganancias Totales:</span> <span>RD$<span id="total-profit">0.00</span></span></div>
          <div><span id="lbl-avg-margin">Margen Promedio:</span> <span><span id="avg-margin">0</span>%</span></div>
          <div><span id="lbl-total-invoices">Facturas Totales:</span> <span><span id="total-invoices">0</span></span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Workflow -->
<div id="workflowModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('workflowModal')">&times;</span>
    <h2 id="lbl-workflow-title">Flujo de Trabajo</h2>
    
    <div class="tabs">
      <button class="tab active" onclick="openWorkflowTab(event, 'received-tab')" id="tab-received">Recibidos</button>
      <button class="tab" onclick="openWorkflowTab(event, 'printing-tab')" id="tab-printing">En Impresión</button>
      <button class="tab" onclick="openWorkflowTab(event, 'completed-tab')" id="tab-completed">Terminados</button>
      <button class="tab" onclick="openWorkflowTab(event, 'delivered-tab')" id="tab-delivered">Entregados</button>
      <button class="tab" onclick="openWorkflowTab(event, 'paid-tab')" id="tab-paid">Pagados</button>
    </div>
    
    <div id="received-tab" class="tab-content active">
      <div id="received-list" style="max-height: 500px; overflow-y: auto;"></div>
    </div>
    
    <div id="printing-tab" class="tab-content">
      <div id="printing-list" style="max-height: 500px; overflow-y: auto;"></div>
    </div>
    
    <div id="completed-tab" class="tab-content">
      <div id="completed-list" style="max-height: 500px; overflow-y: auto;"></div>
    </div>
    
    <div id="delivered-tab" class="tab-content">
      <div id="delivered-list" style="max-height: 500px; overflow-y: auto;"></div>
    </div>
    
    <div id="paid-tab" class="tab-content">
      <div id="paid-list" style="max-height: 500px; overflow-y: auto;"></div>
    </div>
  </div>
</div>

<!-- Modal WhatsApp -->
<div id="whatsappModal" class="modal">
  <div class="modal-content whatsapp-modal-content">
    <span class="close" onclick="closeModal('whatsappModal')">&times;</span>
    <h2 id="lbl-whatsapp-title">Enviar Mensaje por WhatsApp</h2>
    
    <div class="whatsapp-message" id="whatsapp-message-preview">
      <!-- El mensaje se generará aquí -->
    </div>
    
    <div class="whatsapp-templates">
      <h3 id="lbl-whatsapp-templates">Plantillas de Mensaje</h3>
      <div class="whatsapp-template" onclick="useWhatsAppTemplate('invoice')">
        <strong id="lbl-template-invoice">Factura lista</strong>
        <p id="template-invoice-text">Hola {cliente}, tu factura #{factura} está lista. Total: RD${total}. ¿Necesitas alguna aclaración?</p>
      </div>
      <div class="whatsapp-template" onclick="useWhatsAppTemplate('printing')">
        <strong id="lbl-template-printing">En impresión</strong>
        <p id="template-printing-text">Hola {cliente}, tu pedido #{factura} está en proceso de impresión. Te mantendremos informado.</p>
      </div>
      <div class="whatsapp-template" onclick="useWhatsAppTemplate('completed')">
        <strong id="lbl-template-completed">Terminado</strong>
        <p id="template-completed-text">Hola {cliente}, tu pedido #{factura} está terminado. ¿Cuándo podrás recogerlo?</p>
      </div>
      <div class="whatsapp-template" onclick="useWhatsAppTemplate('delivered')">
        <strong id="lbl-template-delivered">Entregado</strong>
        <p id="template-delivered-text">Hola {cliente}, tu pedido #{factura} ha sido entregado. ¡Gracias por confiar en nosotros!</p>
      </div>
      <div class="whatsapp-template" onclick="useWhatsAppTemplate('payment')">
        <strong id="lbl-template-payment">Recordatorio de pago</strong>
        <p id="template-payment-text">Hola {cliente}, recuerda que tienes un saldo pendiente de RD${saldo} en la factura #{factura}. ¿Necesitas alguna aclaración?</p>
      </div>
      <div class="whatsapp-template" onclick="useWhatsAppTemplate('feedback')">
        <strong id="lbl-template-feedback">Solicitud de feedback</strong>
        <p id="template-feedback-text">Hola {cliente}, ¿cómo ha sido tu experiencia con nuestro servicio? Agradecemos tus comentarios.</p>
      </div>
    </div>
    
    <div style="margin-top: 20px;">
      <button class="btn-whatsapp" onclick="sendWhatsAppMessage()" id="btn-send-whatsapp">Enviar por WhatsApp</button>
      <button class="btn-save" onclick="copyWhatsAppMessage()" id="btn-copy-whatsapp">Copiar Mensaje</button>
    </div>
  </div>
</div>

<script>
  // Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDh3ERqBfRMjGliGuKxL16wPoGjARQ5L0Q",
    authDomain: "facturas-fa510.firebaseapp.com",
    databaseURL: "https://facturas-fa510-default-rtdb.firebaseio.com",
    projectId: "facturas-fa510",
    storageBucket: "facturas-fa510.appspot.com",
    messagingSenderId: "1045051500553",
    appId: "1:1045051500553:web:180cfd9978cf1f2d2c30d8",
    measurementId: "G-58CQ3L3XNN"
  };

  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Variables globales
  let currentInvoiceId = null;
  let currentLang = navigator.language.startsWith('es') ? 'es' : 'en';
  let monthlyProfitChart = null;
  let filamentUsageChart = null;
  let currentWhatsAppTemplate = null;

  // Generar número de factura único
  function generateInvoiceNumber() {
    const now = new Date();
    const year = now.getFullYear().toString().slice(-2);
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    return `FAC-${year}${month}${day}-${hours}${minutes}${seconds}`;
  }

  // Inicializar número de factura
  document.getElementById('invoiceNumber').value = generateInvoiceNumber();

  // Traducciones
  const translations = {
    es: {
      "app-title": "Factura",
      "lbl-customer-name": "Nombre del Cliente",
      "lbl-invoice-number": "Número de Factura",
      "lbl-status": "Estado del Pedido",
      "lbl-electricity-price": "Precio de la electricidad (RD$/kWh)",
      "lbl-print-hours": "Horas de impresión",
      "lbl-weight": "Peso del modelo (g)",
      "lbl-filament-price": "Precio del filamento (RD$/kg)",
      "lbl-filament-type": "Tipo de Filamento",
      "lbl-labor-cost": "Mano de obra (RD$)",
      "lbl-other-costs": "Otros costos (RD$)",
      "lbl-maintenance-cost": "Costo de mantenimiento (RD$)",
      "lbl-printer-depreciation": "Depreciación de impresora (RD$/hora)",
      "lbl-margin": "Margen de ganancia (%)",
      "lbl-exchange-rate": "Tasa de cambio USD a RD$",
      "lbl-material-cost": "Costo del material:",
      "lbl-energy-cost": "Costo de energía eléctrica:",
      "lbl-printing-cost": "Costo de impresión:",
      "lbl-maintenance-cost-admin": "Costo de mantenimiento:",
      "lbl-labor-cost-admin": "Costo de mano de obra:",
      "lbl-other-costs-admin": "Otros costos:",
      "lbl-total-cost": "Costo total:",
      "lbl-suggested-price": "Precio sugerido:",
      "lbl-net-profit": "Ganancia neta:",
      "lbl-customer-material-cost": "Materiales utilizados:",
      "lbl-customer-energy-cost": "Consumo energético:",
      "lbl-customer-printing-cost": "Tiempo de máquina:",
      "lbl-customer-service-cost": "Servicio técnico:",
      "lbl-customer-total-price": "Precio Total:",
      "btn-export": "Exportar a PDF",
      "btn-save": "Guardar en Historial",
      "btn-clear": "Limpiar Formulario",
      "btn-lang": "Cambiar Idioma",
      "btn-dashboard": "Dashboard",
      "btn-template": "Guardar Plantilla",
      "btn-payment": "Marcar como Pagado",
      "btn-workflow": "Flujo de Trabajo",
      "btn-whatsapp": "Enviar por WhatsApp",
      "btn-notify": "Notificar Estado",
      "lbl-history": "Historial de Impresiones",
      "lbl-admin-results": "Resultados (Administrador)",
      "lbl-customer-results": "Detalles de la Factura (Cliente)",
      "lbl-dashboard-title": "Dashboard Analytics",
      "lbl-monthly-profit": "Ganancias Mensuales",
      "lbl-filament-usage": "Uso de Filamento",
      "lbl-recent-activity": "Actividad Reciente",
      "lbl-inventory": "Inventario de Filamento",
      "lbl-add-inventory": "Agregar al Inventario",
      "lbl-inv-filament-type": "Tipo de Filamento",
      "lbl-inv-color": "Color",
      "lbl-inv-quantity": "Cantidad (kg)",
      "lbl-inv-price": "Precio por kg (RD$)",
      "btn-add-inventory": "Agregar al Inventario",
      "lbl-pending-payments": "Pagos Pendientes",
      "lbl-financial-summary": "Resumen Financiero",
      "lbl-total-sales": "Ventas Totales:",
      "lbl-total-pending": "Total Pendiente:",
      "lbl-total-costs": "Costos Totales:",
      "lbl-total-profit": "Ganancias Totales:",
      "lbl-avg-margin": "Margen Promedio:",
      "lbl-total-invoices": "Facturas Totales:",
      "lbl-workflow-title": "Flujo de Trabajo",
      "tab-stats": "Estadísticas",
      "tab-customers": "Clientes",
      "tab-templates": "Plantillas",
      "tab-inventory": "Inventario",
      "tab-reports": "Reportes",
      "tab-received": "Recibidos",
      "tab-printing": "En Impresión",
      "tab-completed": "Terminados",
      "tab-delivered": "Entregados",
      "tab-paid": "Pagados",
      "customer-search-placeholder": "Buscar clientes...",
      "template-search-placeholder": "Buscar plantillas...",
      "status-received": "Recibido",
      "status-printing": "En impresión",
      "status-completed": "Terminado",
      "status-delivered": "Entregado",
      "status-paid": "Pagado",
      "status-pending": "Pendiente",
      "btn-edit": "Editar",
      "btn-delete": "Eliminar",
      "confirm-delete": "¿Estás seguro de que quieres eliminar esta factura?",
      "invoice-updated": "Factura actualizada correctamente",
      "invoice-deleted": "Factura eliminada correctamente",
      "lbl-amount-paid": "Monto Abonado (RD$)",
      "lbl-remaining-balance": "Saldo Pendiente (RD$)",
      "lbl-whatsapp-title": "Enviar Mensaje por WhatsApp",
      "lbl-whatsapp-templates": "Plantillas de Mensaje",
      "lbl-template-invoice": "Factura lista",
      "template-invoice-text": "Hola {cliente}, tu factura #{factura} está lista. Total: RD${total}. ¿Necesitas alguna aclaración?",
      "lbl-template-printing": "En impresión",
      "template-printing-text": "Hola {cliente}, tu pedido #{factura} está en proceso de impresión. Te mantendremos informado.",
      "lbl-template-completed": "Terminado",
      "template-completed-text": "Hola {cliente}, tu pedido #{factura} está terminado. ¿Cuándo podrás recogerlo?",
      "lbl-template-delivered": "Entregado",
      "template-delivered-text": "Hola {cliente}, tu pedido #{factura} ha sido entregado. ¡Gracias por confiar en nosotros!",
      "lbl-template-payment": "Recordatorio de pago",
      "template-payment-text": "Hola {cliente}, recuerda que tienes un saldo pendiente de RD${saldo} en la factura #{factura}. ¿Necesitas alguna aclaración?",
      "lbl-template-feedback": "Solicitud de feedback",
      "template-feedback-text": "Hola {cliente}, ¿cómo ha sido tu experiencia con nuestro servicio? Agradecemos tus comentarios.",
      "btn-send-whatsapp": "Enviar por WhatsApp",
      "btn-copy-whatsapp": "Copiar Mensaje",
      "message-copied": "Mensaje copiado al portapapeles",
      "whatsapp-sent": "Mensaje preparado para WhatsApp",
      "notification-sent": "Notificación enviada al cliente",
      "checklist-title": "Checklist de Preparación",
      "checklist-1": "Verificar archivo STL",
      "checklist-2": "Revisar dimensiones del modelo",
      "checklist-3": "Confirmar tipo de filamento",
      "checklist-4": "Calibrar impresora",
      "checklist-5": "Preparar área de trabajo",
      "tasks-title": "Asignación de Tareas",
      "task-design": "Diseño",
      "task-printing": "Impresión",
      "task-post": "Post-procesado",
      "task-delivery": "Entrega"
    },
    en: {
      "app-title": "Invoice",
      "lbl-customer-name": "Customer Name",
      "lbl-invoice-number": "Invoice Number",
      "lbl-status": "Order Status",
      "lbl-electricity-price": "Electricity Price (RD$/kWh)",
      "lbl-print-hours": "Print Hours",
      "lbl-weight": "Model Weight (g)",
      "lbl-filament-price": "Filament Price (RD$/kg)",
      "lbl-filament-type": "Filament Type",
      "lbl-labor-cost": "Labor Cost (RD$)",
      "lbl-other-costs": "Other Costs (RD$)",
      "lbl-maintenance-cost": "Maintenance Cost (RD$)",
      "lbl-printer-depreciation": "Printer Depreciation (RD$/hour)",
      "lbl-margin": "Profit Margin (%)",
      "lbl-exchange-rate": "Exchange Rate USD to RD$",
      "lbl-material-cost": "Material Cost:",
      "lbl-energy-cost": "Electricity Cost:",
      "lbl-printing-cost": "Printing Cost:",
      "lbl-maintenance-cost-admin": "Maintenance Cost:",
      "lbl-labor-cost-admin": "Labor Cost:",
      "lbl-other-costs-admin": "Other Costs:",
      "lbl-total-cost": "Total Cost:",
      "lbl-suggested-price": "Suggested Price:",
      "lbl-net-profit": "Net Profit:",
      "lbl-customer-material-cost": "Materials used:",
      "lbl-customer-energy-cost": "Energy consumption:",
      "lbl-customer-printing-cost": "Machine time:",
      "lbl-customer-service-cost": "Technical service:",
      "lbl-customer-total-price": "Total Price:",
      "btn-export": "Export to PDF",
      "btn-save": "Save to History",
      "btn-clear": "Clear Form",
      "btn-lang": "Toggle Language",
      "btn-dashboard": "Dashboard",
      "btn-template": "Save Template",
      "btn-payment": "Mark as Paid",
      "btn-workflow": "Workflow",
      "btn-whatsapp": "Send via WhatsApp",
      "btn-notify": "Notify Status",
      "lbl-history": "Print History",
      "lbl-admin-results": "Results (Admin)",
      "lbl-customer-results": "Invoice Details (Customer)",
      "lbl-dashboard-title": "Dashboard Analytics",
      "lbl-monthly-profit": "Monthly Profits",
      "lbl-filament-usage": "Filament Usage",
      "lbl-recent-activity": "Recent Activity",
      "lbl-inventory": "Filament Inventory",
      "lbl-add-inventory": "Add to Inventory",
      "lbl-inv-filament-type": "Filament Type",
      "lbl-inv-color": "Color",
      "lbl-inv-quantity": "Quantity (kg)",
      "lbl-inv-price": "Price per kg (RD$)",
      "btn-add-inventory": "Add to Inventory",
      "lbl-pending-payments": "Pending Payments",
      "lbl-financial-summary": "Financial Summary",
      "lbl-total-sales": "Total Sales:",
      "lbl-total-pending": "Total Pending:",
      "lbl-total-costs": "Total Costs:",
      "lbl-total-profit": "Total Profit:",
      "lbl-avg-margin": "Average Margin:",
      "lbl-total-invoices": "Total Invoices:",
      "lbl-workflow-title": "Workflow",
      "tab-stats": "Statistics",
      "tab-customers": "Customers",
      "tab-templates": "Templates",
      "tab-inventory": "Inventory",
      "tab-reports": "Reports",
      "tab-received": "Received",
      "tab-printing": "Printing",
      "tab-completed": "Completed",
      "tab-delivered": "Delivered",
      "tab-paid": "Paid",
      "customer-search-placeholder": "Search customers...",
      "template-search-placeholder": "Search templates...",
      "status-received": "Received",
      "status-printing": "Printing",
      "status-completed": "Completed",
      "status-delivered": "Delivered",
      "status-paid": "Paid",
      "status-pending": "Pending",
      "btn-edit": "Edit",
      "btn-delete": "Delete",
      "confirm-delete": "Are you sure you want to delete this invoice?",
      "invoice-updated": "Invoice updated successfully",
      "invoice-deleted": "Invoice deleted successfully",
      "lbl-amount-paid": "Amount Paid (RD$)",
      "lbl-remaining-balance": "Remaining Balance (RD$)",
      "lbl-whatsapp-title": "Send WhatsApp Message",
      "lbl-whatsapp-templates": "Message Templates",
      "lbl-template-invoice": "Invoice ready",
      "template-invoice-text": "Hello {customer}, your invoice #{invoice} is ready. Total: RD${total}. Do you need any clarification?",
      "lbl-template-printing": "Printing",
      "template-printing-text": "Hello {customer}, your order #{invoice} is being printed. We'll keep you updated.",
      "lbl-template-completed": "Completed",
      "template-completed-text": "Hello {customer}, your order #{invoice} is completed. When can you pick it up?",
      "lbl-template-delivered": "Delivered",
      "template-delivered-text": "Hello {customer}, your order #{invoice} has been delivered. Thank you for trusting us!",
      "lbl-template-payment": "Payment reminder",
      "template-payment-text": "Hello {customer}, remember you have a pending balance of RD${balance} for invoice #{invoice}. Do you need any clarification?",
      "lbl-template-feedback": "Feedback request",
      "template-feedback-text": "Hello {customer}, how was your experience with our service? We appreciate your feedback.",
      "btn-send-whatsapp": "Send via WhatsApp",
      "btn-copy-whatsapp": "Copy Message",
      "message-copied": "Message copied to clipboard",
      "whatsapp-sent": "Message prepared for WhatsApp",
      "notification-sent": "Notification sent to customer",
      "checklist-title": "Preparation Checklist",
      "checklist-1": "Verify STL file",
      "checklist-2": "Check model dimensions",
      "checklist-3": "Confirm filament type",
      "checklist-4": "Calibrate printer",
      "checklist-5": "Prepare work area",
      "tasks-title": "Task Assignment",
      "task-design": "Design",
      "task-printing": "Printing",
      "task-post": "Post-processing",
      "task-delivery": "Delivery"
    }
  };

  function translatePage() {
    Object.keys(translations[currentLang]).forEach(key => {
      const element = document.getElementById(key);
      if (element) {
        element.innerText = translations[currentLang][key];
      }
      
      // Actualizar placeholders
      if (key === "customer-search-placeholder") {
        document.getElementById("customerSearch").placeholder = translations[currentLang][key];
      }
      if (key === "template-search-placeholder") {
        document.getElementById("templateSearch").placeholder = translations[currentLang][key];
      }
    });
  }

  function toggleLang() {
    currentLang = currentLang === 'es' ? 'en' : 'es';
    translatePage();
    calculateResults();
  }

  // Mostrar/ocultar sección de pagos según estado
  function togglePaymentSection() {
    const status = document.getElementById("status").value;
    const paymentSection = document.getElementById("payment-section");
    
    if (status === "received" || status === "printing") {
      paymentSection.classList.add("active");
      updateRemainingBalance();
    } else {
      paymentSection.classList.remove("active");
    }
  }

  // Actualizar saldo pendiente
  function updateRemainingBalance() {
    const suggestedPrice = parseFloat(document.getElementById("suggestedPrice").textContent) || 0;
    const amountPaid = parseFloat(document.getElementById("amountPaid").value) || 0;
    const remainingBalance = suggestedPrice - amountPaid;
    
    document.getElementById("remainingBalance").value = remainingBalance.toFixed(2);
  }

  // Cálculos
  const results = {
    materialCost: document.getElementById("materialCost"),
    energyCost: document.getElementById("energyCost"),
    printingCost: document.getElementById("printingCost"),
    maintenanceCostAdmin: document.getElementById("maintenanceCostAdmin"),
    laborCostAdmin: document.getElementById("laborCostAdmin"),
    otherCostsAdmin: document.getElementById("otherCostsAdmin"),
    totalCost: document.getElementById("totalCost"),
    suggestedPrice: document.getElementById("suggestedPrice"),
    netProfit: document.getElementById("netProfit"),
    customerMaterialCost: document.getElementById("customerMaterialCost"),
    customerEnergyCost: document.getElementById("customerEnergyCost"),
    customerPrintingCost: document.getElementById("customerPrintingCost"),
    customerServiceCost: document.getElementById("customerServiceCost"),
    customerTotalPrice: document.getElementById("customerTotalPrice")
  };

  function calculateResults() {
    const electricityPrice = parseFloat(document.getElementById("electricityPrice").value) || 0;
    const printHours = parseFloat(document.getElementById("printHours").value) || 0;
    const weight = parseFloat(document.getElementById("weight").value) || 0;
    const filamentPrice = parseFloat(document.getElementById("filamentPrice").value) || 0;
    const laborCost = parseFloat(document.getElementById("laborCost").value) || 0;
    const otherCosts = parseFloat(document.getElementById("otherCosts").value) || 0;
    const maintenanceCost = parseFloat(document.getElementById("maintenanceCost").value) || 0;
    const printerDepreciation = parseFloat(document.getElementById("printerDepreciation").value) || 0;
    const margin = parseFloat(document.getElementById("margin").value) || 0;

    const printerPowerKw = 0.15; // kW

    const energyConsumption = printerPowerKw * printHours;
    const energyCost = energyConsumption * electricityPrice;
    const printingCost = (electricityPrice * printerPowerKw + printerDepreciation) * printHours;
    const materialCost = (weight / 1000) * filamentPrice;
    const totalCost = materialCost + energyCost + printingCost + laborCost + otherCosts + maintenanceCost;
    const suggestedPrice = totalCost * (1 + margin / 100);
    const netProfit = suggestedPrice - totalCost;

    // Resultados para administrador
    results.materialCost.textContent = materialCost.toFixed(2);
    results.energyCost.textContent = energyCost.toFixed(2);
    results.printingCost.textContent = printingCost.toFixed(2);
    results.maintenanceCostAdmin.textContent = maintenanceCost.toFixed(2);
    results.laborCostAdmin.textContent = laborCost.toFixed(2);
    results.otherCostsAdmin.textContent = otherCosts.toFixed(2);
    results.totalCost.textContent = totalCost.toFixed(2);
    results.suggestedPrice.textContent = suggestedPrice.toFixed(2);
    results.netProfit.textContent = netProfit.toFixed(2);

    // Resultados para cliente (ajustados para que sumen exactamente el precio total)
    const serviceCost = laborCost + otherCosts + maintenanceCost;
    const adjustedPrintingCost = printingCost * (suggestedPrice / totalCost);
    const adjustedMaterialCost = materialCost * (suggestedPrice / totalCost);
    const adjustedEnergyCost = energyCost * (suggestedPrice / totalCost);
    const adjustedServiceCost = serviceCost * (suggestedPrice / totalCost);
    
    results.customerMaterialCost.textContent = adjustedMaterialCost.toFixed(2);
    results.customerEnergyCost.textContent = adjustedEnergyCost.toFixed(2);
    results.customerPrintingCost.textContent = adjustedPrintingCost.toFixed(2);
    results.customerServiceCost.textContent = adjustedServiceCost.toFixed(2);
    results.customerTotalPrice.textContent = suggestedPrice.toFixed(2);

    // Actualizar saldo pendiente si la sección de pagos está visible
    if (document.getElementById("payment-section").classList.contains("active")) {
      updateRemainingBalance();
    }
  }

  function exportToPDF() {
    // Verificar si jsPDF está cargado
    if (typeof window.jspdf === 'undefined') {
      alert(currentLang === 'es' ? 'Error: La biblioteca jsPDF no está cargada. Por favor recarga la página.' : 'Error: jsPDF library not loaded. Please reload the page.');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const customerName = document.getElementById("customerName").value || (currentLang === 'es' ? "Cliente no especificado" : "Unspecified customer");
    const invoiceNumber = document.getElementById("invoiceNumber").value || "FAC-00000";
    const lang = translations[currentLang];
    
    // Encabezado con logo y nombre
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    
    // Añadir logo (si está disponible)
    try {
      doc.addImage("logo.png", "PNG", 20, 15, 25, 25);
    } catch (e) {
      console.log("Logo no encontrado, continuando sin él");
    }
    
    doc.text("3DCraftRD", 105, 20, null, null, "center");
    doc.setFontSize(14);
    doc.text(lang["app-title"], 105, 27, null, null, "center");
    
    // Información de la factura
    doc.setFontSize(12);
    doc.text(`${lang["lbl-invoice-number"]}: ${invoiceNumber}`, 20, 45);
    doc.text(`${lang["lbl-customer-name"]}: ${customerName}`, 20, 52);
    
    // Fecha
    const now = new Date();
    const dateStr = now.toLocaleDateString();
    doc.text(`${currentLang === 'es' ? 'Fecha' : 'Date'}: ${dateStr}`, 180, 45, null, null, "right");
    
    // Resultados para el cliente
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text(lang["lbl-customer-results"], 20, 70);
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    
    let yPos = 80;
    doc.text(`${lang["lbl-customer-material-cost"]}: RD$${results.customerMaterialCost.textContent}`, 30, yPos);
    yPos += 10;
    doc.text(`${lang["lbl-customer-energy-cost"]}: RD$${results.customerEnergyCost.textContent}`, 30, yPos);
    yPos += 10;
    doc.text(`${lang["lbl-customer-printing-cost"]}: RD$${results.customerPrintingCost.textContent}`, 30, yPos);
    yPos += 10;
    doc.text(`${lang["lbl-customer-service-cost"]}: RD$${results.customerServiceCost.textContent}`, 30, yPos);
    
    // Mostrar información de pagos si está pendiente
    const status = document.getElementById("status").value;
    if (status === "received" || status === "printing") {
      const amountPaid = parseFloat(document.getElementById("amountPaid").value) || 0;
      const remainingBalance = parseFloat(document.getElementById("remainingBalance").value) || 0;
      
      yPos += 15;
      doc.text(`${currentLang === 'es' ? 'Monto abonado:' : 'Amount paid:'}: RD$${amountPaid.toFixed(2)}`, 30, yPos);
      yPos += 10;
      doc.text(`${currentLang === 'es' ? 'Saldo pendiente:' : 'Remaining balance:'}: RD$${remainingBalance.toFixed(2)}`, 30, yPos);
    }
    
    yPos += 15;
    
    // Precio total
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text(`${lang["lbl-customer-total-price"]}: RD$${results.customerTotalPrice.textContent}`, 30, yPos);
    
    // Nota al pie
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(currentLang === 'es' ? "Gracias por su preferencia - 3DCraftRD" : "Thank you for your business - 3DCraftRD", 105, 280, null, null, "center");
    
    // Guardar el PDF
    doc.save(`${currentLang === 'es' ? 'Factura' : 'Invoice'}_${invoiceNumber}.pdf`);
  }

  async function saveToHistory() {
    const customerName = document.getElementById("customerName").value || (currentLang === 'es' ? "Sin nombre" : "No name");
    const invoiceNumber = document.getElementById("invoiceNumber").value || generateInvoiceNumber();
    const status = document.getElementById("status").value;
    const amountPaid = parseFloat(document.getElementById("amountPaid").value) || 0;
    
    const invoiceData = {
      date: new Date().toISOString(),
      customerName: customerName,
      invoiceNumber: invoiceNumber,
      status: status,
      electricityPrice: parseFloat(document.getElementById("electricityPrice").value) || 0,
      printHours: parseFloat(document.getElementById("printHours").value) || 0,
      weight: parseFloat(document.getElementById("weight").value) || 0,
      filamentPrice: parseFloat(document.getElementById("filamentPrice").value) || 0,
      filamentType: document.getElementById("filamentType").value,
      laborCost: parseFloat(document.getElementById("laborCost").value) || 0,
      otherCosts: parseFloat(document.getElementById("otherCosts").value) || 0,
      maintenanceCost: parseFloat(document.getElementById("maintenanceCost").value) || 0,
      printerDepreciation: parseFloat(document.getElementById("printerDepreciation").value) || 0,
      margin: parseFloat(document.getElementById("margin").value) || 0,
      totalCost: parseFloat(results.totalCost.textContent) || 0,
      suggestedPrice: parseFloat(results.suggestedPrice.textContent) || 0,
      exchangeRate: parseFloat(document.getElementById("exchangeRate").value) || 0,
      paid: status === 'paid',
      amountPaid: amountPaid,
      remainingBalance: parseFloat(document.getElementById("remainingBalance").value) || 0
    };
    
    try {
      if (currentInvoiceId) {
        // Actualizar factura existente
        await db.collection("invoices").doc(currentInvoiceId).update(invoiceData);
        alert(translations[currentLang]["invoice-updated"]);
      } else {
        // Crear nueva factura
        await db.collection("invoices").add(invoiceData);
        
        // Actualizar o crear cliente
        const customerQuery = await db.collection("customers").where("name", "==", customerName).get();
        
        if (customerQuery.empty) {
          // Nuevo cliente
          await db.collection("customers").add({
            name: customerName,
            totalSpent: parseFloat(results.suggestedPrice.textContent) || 0,
            invoices: [invoiceNumber],
            lastPurchase: new Date().toISOString(),
            firstPurchase: new Date().toISOString(),
            pendingAmount: status === 'paid' ? 0 : parseFloat(results.suggestedPrice.textContent) - amountPaid || 0
          });
        } else {
          // Cliente existente
          const customerDoc = customerQuery.docs[0];
          const customerData = customerDoc.data();
          const pendingAmount = status === 'paid' ? 
            0 : 
            (customerData.pendingAmount || 0) + (parseFloat(results.suggestedPrice.textContent) - amountPaid) || 0;
          
          await db.collection("customers").doc(customerDoc.id).update({
            totalSpent: (customerData.totalSpent || 0) + parseFloat(results.suggestedPrice.textContent) || 0,
            invoices: [...(customerData.invoices || []), invoiceNumber],
            lastPurchase: new Date().toISOString(),
            pendingAmount: pendingAmount
          });
        }
        
        // Actualizar inventario si el estado no es "received"
        if (status !== 'received') {
          await updateInventory(parseFloat(document.getElementById("weight").value) || 0, document.getElementById("filamentType").value);
        }
        
        alert(currentLang === 'es' ? 'Factura guardada con éxito!' : 'Invoice saved successfully!');
      }
      
      // Generar nuevo número de factura para el próximo
      document.getElementById('invoiceNumber').value = generateInvoiceNumber();
      currentInvoiceId = null; // Resetear el ID de factura actual
      
      // Actualizar historial y alertas
      renderHistory();
      checkAlerts();
    } catch (error) {
      console.error("Error saving invoice:", error);
      alert(currentLang === 'es' ? 'Error al guardar la factura' : 'Error saving invoice');
    }
  }

  async function updateInventory(weightGrams, filamentType) {
    try {
      const weightKg = weightGrams / 1000;
      const filamentName = getFilamentTypeName(filamentType);
      
      const inventoryQuery = await db.collection("inventory")
        .where("type", "==", filamentName)
        .orderBy("date", "desc")
        .limit(1)
        .get();
      
      if (!inventoryQuery.empty) {
        const lastInventory = inventoryQuery.docs[0].data();
        const newQuantity = lastInventory.remaining - weightKg;
        
        if (newQuantity >= 0) {
          await db.collection("inventory").doc(inventoryQuery.docs[0].id).update({
            remaining: newQuantity
          });
        } else {
          console.warn("No hay suficiente filamento en inventario");
        }
      }
    } catch (error) {
      console.error("Error updating inventory:", error);
    }
  }

  async function renderHistory() {
    const list = document.getElementById("history-list");
    list.innerHTML = "";
    
    try {
      const querySnapshot = await db.collection("invoices")
        .orderBy("date", "desc")
        .limit(10)
        .get();
      
      if (querySnapshot.empty) {
        list.innerHTML = `<div style="text-align:center; padding:20px; color:#a0aec0;">${currentLang === 'es' ? 'No hay registros en el historial' : 'No records in history'}</div>`;
        return;
      }
      
      querySnapshot.forEach(doc => {
        const item = doc.data();
        const div = document.createElement("div");
        div.className = "history-item";
        
        let paymentInfo = "";
        if ((item.status === "received" || item.status === "printing") && item.amountPaid > 0) {
          paymentInfo = `<div><small>${currentLang === 'es' ? 'Abonado:' : 'Paid:'} RD$${item.amountPaid.toFixed(2)} (${currentLang === 'es' ? 'Saldo:' : 'Balance:'} RD$${item.remainingBalance.toFixed(2)})</small></div>`;
        }
        
        div.innerHTML = `
          <strong>${new Date(item.date).toLocaleString()}</strong>
          <span class="status-badge ${getStatusClass(item.status)}">${getStatusText(item.status)}</span><br>
          <div style="display:flex; justify-content:space-between; margin-top:8px;">
            <div>
              <strong>${currentLang === 'es' ? 'Cliente' : 'Customer'}:</strong> ${item.customerName}<br>
              <strong>${currentLang === 'es' ? 'Factura' : 'Invoice'}:</strong> ${item.invoiceNumber}
            </div>
            <div style="text-align:right;">
              <strong>${currentLang === 'es' ? 'Total' : 'Total'}:</strong> RD$${item.suggestedPrice.toFixed(2)}
            </div>
          </div>
          ${paymentInfo}
          <div class="history-item-buttons">
            <button class="btn-edit" onclick="editInvoiceFromHistory(event, '${doc.id}')">${translations[currentLang]["btn-edit"]}</button>
            <button class="btn-delete" onclick="deleteInvoiceFromHistory(event, '${doc.id}')">${translations[currentLang]["btn-delete"]}</button>
          </div>
        `;
        list.appendChild(div);
      });
    } catch (error) {
      console.error("Error loading history:", error);
      list.innerHTML = `<div style="text-align:center; padding:20px; color:#a0aec0;">${currentLang === 'es' ? 'Error al cargar el historial' : 'Error loading history'}</div>`;
    }
  }

  function getStatusClass(status) {
    switch(status) {
      case 'received': return 'status-received';
      case 'printing': return 'status-printing';
      case 'completed': return 'status-completed';
      case 'delivered': return 'status-delivered';
      case 'paid': return 'status-paid';
      case 'pending': return 'status-pending';
      default: return '';
    }
  }

  function getStatusText(status) {
    return translations[currentLang][`status-${status}`] || status;
  }

  function editInvoiceFromHistory(event, docId) {
    event.stopPropagation(); // Evitar que el evento se propague al div padre
    loadInvoiceFromHistory(docId);
  }

  async function deleteInvoiceFromHistory(event, docId) {
    event.stopPropagation(); // Evitar que el evento se propague al div padre
    
    if (!confirm(translations[currentLang]["confirm-delete"])) {
      return;
    }
    
    try {
      // Obtener la factura antes de eliminarla para actualizar el cliente
      const invoiceDoc = await db.collection("invoices").doc(docId).get();
      const invoiceData = invoiceDoc.data();
      
      // Eliminar la factura
      await db.collection("invoices").doc(docId).delete();
      
      // Actualizar el cliente si existe
      const customerQuery = await db.collection("customers")
        .where("name", "==", invoiceData.customerName)
        .limit(1)
        .get();
      
      if (!customerQuery.empty) {
        const customerDoc = customerQuery.docs[0];
        const customerData = customerDoc.data();
        
        // Actualizar el total gastado y las facturas del cliente
        const newTotalSpent = (customerData.totalSpent || 0) - (invoiceData.suggestedPrice || 0);
        const newInvoices = (customerData.invoices || []).filter(inv => inv !== invoiceData.invoiceNumber);
        
        // Actualizar el monto pendiente si la factura no estaba pagada
        const newPendingAmount = invoiceData.paid ? 
          customerData.pendingAmount : 
          (customerData.pendingAmount || 0) - (invoiceData.suggestedPrice - (invoiceData.amountPaid || 0));
        
        await db.collection("customers").doc(customerDoc.id).update({
          totalSpent: Math.max(0, newTotalSpent),
          invoices: newInvoices,
          pendingAmount: Math.max(0, newPendingAmount)
        });
      }
      
      alert(translations[currentLang]["invoice-deleted"]);
      renderHistory();
      checkAlerts();
      
      // Si la factura eliminada es la que está actualmente cargada, limpiar el formulario
      if (currentInvoiceId === docId) {
        clearForm();
      }
    } catch (error) {
      console.error("Error deleting invoice:", error);
      alert(currentLang === 'es' ? 'Error al eliminar la factura' : 'Error deleting invoice');
    }
  }

  async function loadInvoiceFromHistory(docId) {
    try {
      const doc = await db.collection("invoices").doc(docId).get();
      if (doc.exists) {
        const data = doc.data();
        
        // Guardar el ID de la factura actual
        currentInvoiceId = docId;
        
        // Cargar los datos en el formulario
        document.getElementById("customerName").value = data.customerName;
        document.getElementById("electricityPrice").value = data.electricityPrice;
        document.getElementById("printHours").value = data.printHours;
        document.getElementById("weight").value = data.weight;
        document.getElementById("filamentPrice").value = data.filamentPrice;
        document.getElementById("filamentType").value = data.filamentType || "1600";
        document.getElementById("laborCost").value = data.laborCost;
        document.getElementById("otherCosts").value = data.otherCosts;
        document.getElementById("maintenanceCost").value = data.maintenanceCost || 0;
        document.getElementById("printerDepreciation").value = data.printerDepreciation || 14.00;
        document.getElementById("margin").value = data.margin;
        document.getElementById("exchangeRate").value = data.exchangeRate || 58.00;
        document.getElementById("invoiceNumber").value = data.invoiceNumber;
        document.getElementById("status").value = data.status || "received";
        document.getElementById("amountPaid").value = data.amountPaid || 0;
        document.getElementById("remainingBalance").value = data.remainingBalance || 0;
        
        // Mostrar/ocultar sección de pagos según estado
        togglePaymentSection();
        
        calculateResults();
        
        // Cambiar el texto del botón de guardar
        document.getElementById("btn-save").textContent = currentLang === 'es' ? 'Actualizar Factura' : 'Update Invoice';
      }
    } catch (error) {
      console.error("Error loading invoice:", error);
    }
  }

  function clearForm() {
    document.getElementById("customerName").value = "";
    document.getElementById("electricityPrice").value = "2.80";
    document.getElementById("printHours").value = "6";
    document.getElementById("weight").value = "150";
    document.getElementById("filamentPrice").value = "1600";
    document.getElementById("filamentType").value = "1600";
    document.getElementById("laborCost").value = "150";
    document.getElementById("otherCosts").value = "100";
    document.getElementById("maintenanceCost").value = "50";
    document.getElementById("printerDepreciation").value = "14.00";
    document.getElementById("margin").value = "40";
    document.getElementById("exchangeRate").value = "58.00";
    document.getElementById("status").value = "received";
    document.getElementById("amountPaid").value = "0";
    document.getElementById("remainingBalance").value = "0";
    document.getElementById('invoiceNumber').value = generateInvoiceNumber();
    calculateResults();
    
    // Ocultar sección de pagos
    document.getElementById("payment-section").classList.remove("active");
    
    // Restablecer el botón de guardar
    document.getElementById("btn-save").textContent = translations[currentLang]["btn-save"];
    
    // Limpiar el ID de la factura actual
    currentInvoiceId = null;
    
    // Mostrar notificación
    alert(currentLang === 'es' ? 'Formulario limpiado!' : 'Form cleared!');
  }

  async function markAsPaid() {
    const customerName = document.getElementById("customerName").value;
    const invoiceNumber = document.getElementById("invoiceNumber").value;
    
    if (!customerName || !invoiceNumber) {
      alert(currentLang === 'es' ? 'Por favor complete los datos del cliente y número de factura' : 'Please fill in customer name and invoice number');
      return;
    }
    
    try {
      let invoiceDoc;
      
      if (currentInvoiceId) {
        // Actualizar factura existente
        invoiceDoc = await db.collection("invoices").doc(currentInvoiceId).get();
        await db.collection("invoices").doc(currentInvoiceId).update({
          status: 'paid',
          paid: true,
          amountPaid: parseFloat(results.suggestedPrice.textContent) || 0,
          remainingBalance: 0
        });
      } else {
        // Buscar la factura en Firestore
        const invoiceQuery = await db.collection("invoices")
          .where("invoiceNumber", "==", invoiceNumber)
          .limit(1)
          .get();
        
        if (invoiceQuery.empty) {
          alert(currentLang === 'es' ? 'No se encontró la factura' : 'Invoice not found');
          return;
        }
        
        invoiceDoc = invoiceQuery.docs[0];
        await db.collection("invoices").doc(invoiceDoc.id).update({
          status: 'paid',
          paid: true,
          amountPaid: parseFloat(results.suggestedPrice.textContent) || 0,
          remainingBalance: 0
        });
      }
      
      // Actualizar el cliente para reducir el monto pendiente
      const customerQuery = await db.collection("customers")
        .where("name", "==", customerName)
        .limit(1)
        .get();
      
      if (!customerQuery.empty) {
        const customerDoc = customerQuery.docs[0];
        const customerData = customerDoc.data();
        const invoiceData = invoiceDoc.data();
        const pendingAmount = (customerData.pendingAmount || 0) - (parseFloat(results.suggestedPrice.textContent) - (invoiceData.amountPaid || 0)) || 0;
        
        await db.collection("customers").doc(customerDoc.id).update({
          pendingAmount: Math.max(0, pendingAmount)
        });
      }
      
      // Actualizar estado en el formulario
      document.getElementById("status").value = "paid";
      document.getElementById("amountPaid").value = parseFloat(results.suggestedPrice.textContent) || 0;
      document.getElementById("remainingBalance").value = 0;
      
      // Ocultar sección de pagos
      document.getElementById("payment-section").classList.remove("active");
      
      alert(currentLang === 'es' ? 'Factura marcada como pagada!' : 'Invoice marked as paid!');
      checkAlerts();
    } catch (error) {
      console.error("Error marking as paid:", error);
      alert(currentLang === 'es' ? 'Error al marcar como pagada' : 'Error marking as paid');
    }
  }

  // Funciones del Dashboard
  function openDashboard() {
    document.getElementById("dashboardModal").style.display = "block";
    loadDashboardData();
  }

  function openWorkflow() {
    document.getElementById("workflowModal").style.display = "block";
    loadWorkflowData();
  }

  function closeModal(modalId) {
    document.getElementById(modalId).style.display = "none";
  }

  function openTab(evt, tabName) {
    const tabContents = document.getElementsByClassName("tab-content");
    for (let i = 0; i < tabContents.length; i++) {
      tabContents[i].classList.remove("active");
    }
    
    const tabs = document.getElementsByClassName("tab");
    for (let i = 0; i < tabs.length; i++) {
      tabs[i].classList.remove("active");
    }
    
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
  }

  function openWorkflowTab(evt, tabName) {
    const tabContents = document.querySelectorAll("#workflowModal .tab-content");
    for (let i = 0; i < tabContents.length; i++) {
      tabContents[i].classList.remove("active");
    }
    
    const tabs = document.querySelectorAll("#workflowModal .tab");
    for (let i = 0; i < tabs.length; i++) {
      tabs[i].classList.remove("active");
    }
    
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
  }

  async function loadDashboardData() {
    try {
      // Cargar datos para gráficos
      const invoicesSnapshot = await db.collection("invoices")
        .orderBy("date", "desc")
        .limit(30)
        .get();
      
      const customersSnapshot = await db.collection("customers")
        .orderBy("lastPurchase", "desc")
        .get();
      
      const templatesSnapshot = await db.collection("templates")
        .orderBy("name")
        .get();
      
      const inventorySnapshot = await db.collection("inventory")
        .orderBy("date", "desc")
        .get();
      
      // Procesar datos para gráficos
      const invoicesData = invoicesSnapshot.docs.map(doc => doc.data());
      const customersData = customersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const templatesData = templatesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const inventoryData = inventorySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      // Actualizar pestaña de clientes
      renderCustomersList(customersData);
      
      // Actualizar pestaña de plantillas
      renderTemplatesList(templatesData);
      
      // Actualizar pestaña de inventario
      renderInventoryList(inventoryData);
      
      // Actualizar actividad reciente
      renderRecentActivity(invoicesData);
      
      // Actualizar reportes financieros
      renderFinancialReports(invoicesData, customersData);
      
      // Crear gráficos
      createMonthlyProfitChart(invoicesData);
      createFilamentUsageChart(invoicesData);
      
    } catch (error) {
      console.error("Error loading dashboard data:", error);
    }
  }

  async function loadWorkflowData() {
    try {
      const receivedQuery = await db.collection("invoices")
        .where("status", "==", "received")
        .orderBy("date", "desc")
        .get();
      
      const printingQuery = await db.collection("invoices")
        .where("status", "==", "printing")
        .orderBy("date", "desc")
        .get();
      
      const completedQuery = await db.collection("invoices")
        .where("status", "==", "completed")
        .orderBy("date", "desc")
        .get();
      
      const deliveredQuery = await db.collection("invoices")
        .where("status", "==", "delivered")
        .orderBy("date", "desc")
        .get();
      
      const paidQuery = await db.collection("invoices")
        .where("status", "==", "paid")
        .orderBy("date", "desc")
        .get();
      
      const receivedData = receivedQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const printingData = printingQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const completedData = completedQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const deliveredData = deliveredQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const paidData = paidQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      renderWorkflowList("received-list", receivedData);
      renderWorkflowList("printing-list", printingData);
      renderWorkflowList("completed-list", completedData);
      renderWorkflowList("delivered-list", deliveredData);
      renderWorkflowList("paid-list", paidData);
      
    } catch (error) {
      console.error("Error loading workflow data:", error);
    }
  }

  function renderWorkflowList(listId, items) {
    const list = document.getElementById(listId);
    list.innerHTML = "";
    
    if (items.length === 0) {
      list.innerHTML = `<div style="text-align:center; padding:20px; color:#a0aec0;">${currentLang === 'es' ? 'No hay elementos' : 'No items'}</div>`;
      return;
    }
    
    items.forEach(item => {
      const div = document.createElement("div");
      div.className = "workflow-card";
      
      let paymentInfo = "";
      if ((item.status === "received" || item.status === "printing") && item.amountPaid > 0) {
        paymentInfo = `<div><small>${currentLang === 'es' ? 'Abonado:' : 'Paid:'} RD$${item.amountPaid.toFixed(2)} (${currentLang === 'es' ? 'Saldo:' : 'Balance:'} RD$${item.remainingBalance.toFixed(2)})</small></div>`;
      }
      
      // Checklist de preparación
      let checklist = "";
      if (item.status === "received") {
        checklist = `
          <div style="margin-top: 10px;">
            <strong>${translations[currentLang]["checklist-title"]}</strong>
            <div class="checklist-item">
              <input type="checkbox" id="check-1" ${item.checklist?.includes('check-1') ? 'checked' : ''}>
              <label for="check-1">${translations[currentLang]["checklist-1"]}</label>
            </div>
            <div class="checklist-item">
              <input type="checkbox" id="check-2" ${item.checklist?.includes('check-2') ? 'checked' : ''}>
              <label for="check-2">${translations[currentLang]["checklist-2"]}</label>
            </div>
            <div class="checklist-item">
              <input type="checkbox" id="check-3" ${item.checklist?.includes('check-3') ? 'checked' : ''}>
              <label for="check-3">${translations[currentLang]["checklist-3"]}</label>
            </div>
            <div class="checklist-item">
              <input type="checkbox" id="check-4" ${item.checklist?.includes('check-4') ? 'checked' : ''}>
              <label for="check-4">${translations[currentLang]["checklist-4"]}</label>
            </div>
            <div class="checklist-item">
              <input type="checkbox" id="check-5" ${item.checklist?.includes('check-5') ? 'checked' : ''}>
              <label for="check-5">${translations[currentLang]["checklist-5"]}</label>
            </div>
          </div>
        `;
      }
      
      // Asignación de tareas
      let tasks = "";
      if (item.status === "printing" || item.status === "completed") {
        tasks = `
          <div class="task-assignment">
            <strong>${translations[currentLang]["tasks-title"]}</strong>
            <div class="task-item">
              <span>${translations[currentLang]["task-design"]}</span>
              <select>
                <option>${currentLang === 'es' ? 'Asignar' : 'Assign'}</option>
                <option>Juan</option>
                <option>María</option>
                <option>Carlos</option>
              </select>
            </div>
            <div class="task-item">
              <span>${translations[currentLang]["task-printing"]}</span>
              <select>
                <option>${currentLang === 'es' ? 'Asignar' : 'Assign'}</option>
                <option>Juan</option>
                <option>María</option>
                <option>Carlos</option>
              </select>
            </div>
            <div class="task-item">
              <span>${translations[currentLang]["task-post"]}</span>
              <select>
                <option>${currentLang === 'es' ? 'Asignar' : 'Assign'}</option>
                <option>Juan</option>
                <option>María</option>
                <option>Carlos</option>
              </select>
            </div>
            <div class="task-item">
              <span>${translations[currentLang]["task-delivery"]}</span>
              <select>
                <option>${currentLang === 'es' ? 'Asignar' : 'Assign'}</option>
                <option>Juan</option>
                <option>María</option>
                <option>Carlos</option>
              </select>
            </div>
          </div>
        `;
      }
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between;">
          <div>
            <strong>${item.customerName}</strong><br>
            <small>${item.invoiceNumber}</small>
          </div>
          <div style="text-align: right;">
            <strong>RD$${item.suggestedPrice.toFixed(2)}</strong><br>
            <small>${new Date(item.date).toLocaleDateString()}</small>
          </div>
        </div>
        ${paymentInfo}
        ${checklist}
        ${tasks}
        <div style="margin-top: 10px; display: flex; justify-content: space-between;">
          <button class="btn-save" style="padding: 5px 10px; font-size: 0.8rem;" onclick="updateWorkflowStatus('${item.id}', '${getNextStatus(item.status)}')">
            ${getNextStatusText(item.status)}
          </button>
          <button class="btn-export" style="padding: 5px 10px; font-size: 0.8rem;" onclick="loadWorkflowItem('${item.id}')">
            ${currentLang === 'es' ? 'Ver' : 'View'}
          </button>
          <button class="btn-whatsapp" style="padding: 5px 10px; font-size: 0.8rem;" onclick="openWhatsAppModal('${item.id}')">
            WhatsApp
          </button>
        </div>
      `;
      list.appendChild(div);
    });
  }

  function getNextStatus(currentStatus) {
    switch(currentStatus) {
      case 'received': return 'printing';
      case 'printing': return 'completed';
      case 'completed': return 'delivered';
      case 'delivered': return 'paid';
      default: return currentStatus;
    }
  }

  function getNextStatusText(currentStatus) {
    switch(currentStatus) {
      case 'received': return currentLang === 'es' ? 'Iniciar Impresión' : 'Start Printing';
      case 'printing': return currentLang === 'es' ? 'Marcar Terminado' : 'Mark Completed';
      case 'completed': return currentLang === 'es' ? 'Marcar Entregado' : 'Mark Delivered';
      case 'delivered': return currentLang === 'es' ? 'Marcar Pagado' : 'Mark Paid';
      default: return currentLang === 'es' ? 'Siguiente' : 'Next';
    }
  }

  async function updateWorkflowStatus(docId, newStatus) {
    try {
      const updateData = {
        status: newStatus,
        paid: newStatus === 'paid'
      };
      
      if (newStatus === 'paid') {
        const invoiceDoc = await db.collection("invoices").doc(docId).get();
        const invoiceData = invoiceDoc.data();
        
        updateData.amountPaid = invoiceData.suggestedPrice;
        updateData.remainingBalance = 0;
      }
      
      await db.collection("invoices").doc(docId).update(updateData);
      
      if (newStatus === 'paid') {
        // Actualizar el monto pendiente del cliente
        const invoiceDoc = await db.collection("invoices").doc(docId).get();
        const invoiceData = invoiceDoc.data();
        
        const customerQuery = await db.collection("customers")
          .where("name", "==", invoiceData.customerName)
          .limit(1)
          .get();
        
        if (!customerQuery.empty) {
          const customerDoc = customerQuery.docs[0];
          const customerData = customerDoc.data();
          const pendingAmount = (customerData.pendingAmount || 0) - (invoiceData.suggestedPrice - (invoiceData.amountPaid || 0));
          
          await db.collection("customers").doc(customerDoc.id).update({
            pendingAmount: Math.max(0, pendingAmount)
          });
        }
      }
      
      alert(currentLang === 'es' ? 'Estado actualizado correctamente' : 'Status updated successfully');
      loadWorkflowData();
      checkAlerts();
    } catch (error) {
      console.error("Error updating status:", error);
      alert(currentLang === 'es' ? 'Error al actualizar el estado' : 'Error updating status');
    }
  }

  async function loadWorkflowItem(docId) {
    try {
      const doc = await db.collection("invoices").doc(docId).get();
      if (doc.exists) {
        const data = doc.data();
        loadInvoiceFromHistory(docId, data);
        closeModal("workflowModal");
      }
    } catch (error) {
      console.error("Error loading workflow item:", error);
    }
  }

  function renderCustomersList(customers) {
    const list = document.getElementById("customers-list");
    list.innerHTML = "";
    
    if (customers.length === 0) {
      list.innerHTML = `<div style="text-align:center; padding:20px; color:#a0aec0;">${currentLang === 'es' ? 'No hay clientes registrados' : 'No customers found'}</div>`;
      return;
    }
    
    customers.forEach(customer => {
      const div = document.createElement("div");
      div.className = "customer-card";
      div.innerHTML = `
        <h3>${customer.name}</h3>
        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
          <div>
            <strong>${currentLang === 'es' ? 'Total gastado:' : 'Total spent:'}</strong> RD$${customer.totalSpent?.toFixed(2) || '0.00'}<br>
            <strong>${currentLang === 'es' ? 'Facturas:' : 'Invoices:'}</strong> ${customer.invoices?.length || 0}<br>
            <strong>${currentLang === 'es' ? 'Pendiente:' : 'Pending:'}</strong> RD$${customer.pendingAmount?.toFixed(2) || '0.00'}
          </div>
          <div style="text-align: right;">
            <strong>${currentLang === 'es' ? 'Última compra:' : 'Last purchase:'}</strong><br>
            ${new Date(customer.lastPurchase).toLocaleDateString()}
          </div>
        </div>
      `;
      div.addEventListener("click", () => {
        document.getElementById("customerName").value = customer.name;
        closeModal("dashboardModal");
      });
      list.appendChild(div);
    });
  }

  function renderTemplatesList(templates) {
    const list = document.getElementById("templates-list");
    list.innerHTML = "";
    
    if (templates.length === 0) {
      list.innerHTML = `<div style="text-align:center; padding:20px; color:#a0aec0;">${currentLang === 'es' ? 'No hay plantillas guardadas' : 'No templates found'}</div>`;
      return;
    }
    
    templates.forEach(template => {
      const div = document.createElement("div");
      div.className = "template-card";
      div.innerHTML = `
        <h3>${template.name}</h3>
        <div style="margin-top: 10px;">
          <strong>${currentLang === 'es' ? 'Tipo de filamento:' : 'Filament type:'}</strong> ${getFilamentTypeName(template.filamentPrice)}<br>
          <strong>${currentLang === 'es' ? 'Precio sugerido:' : 'Suggested price:'}</strong> RD$${template.suggestedPrice?.toFixed(2) || '0.00'}
        </div>
      `;
      div.addEventListener("click", () => loadTemplate(template));
      list.appendChild(div);
    });
  }

  function renderInventoryList(inventory) {
    const list = document.getElementById("inventory-list");
    list.innerHTML = "";
    
    if (inventory.length === 0) {
      list.innerHTML = `<div style="text-align:center; padding:20px; color:#a0aec0;">${currentLang === 'es' ? 'No hay registros de inventario' : 'No inventory records'}</div>`;
      return;
    }
    
    // Agrupar por tipo y color
    const groupedInventory = {};
    inventory.forEach(item => {
      const key = `${item.type}-${item.color}`;
      if (!groupedInventory[key]) {
        groupedInventory[key] = {
          type: item.type,
          color: item.color,
          total: 0,
          price: item.price,
          lastUpdated: item.date
        };
      }
      groupedInventory[key].total += item.remaining;
    });
    
    // Convertir a array y ordenar
    const inventoryArray = Object.values(groupedInventory).sort((a, b) => {
      if (a.type < b.type) return -1;
      if (a.type > b.type) return 1;
      if (a.color < b.color) return -1;
      if (a.color > b.color) return 1;
      return 0;
    });
    
    inventoryArray.forEach(item => {
      const div = document.createElement("div");
      div.className = "inventory-card";
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between;">
          <div>
            <strong>${item.type} - ${item.color}</strong><br>
            <small>${currentLang === 'es' ? 'Precio:' : 'Price:'} RD$${item.price?.toFixed(2) || '0.00'}/kg</small>
          </div>
          <div style="text-align: right;">
            <strong>${item.total.toFixed(2)} kg</strong><br>
            <small>${new Date(item.lastUpdated).toLocaleDateString()}</small>
          </div>
        </div>
      `;
      list.appendChild(div);
    });
  }

  async function addToInventory() {
    const type = document.getElementById("inv-filament-type").value;
    const color = document.getElementById("inv-color").value || "Sin color";
    const quantity = parseFloat(document.getElementById("inv-quantity").value) || 0;
    const price = parseFloat(document.getElementById("inv-price").value) || 0;
    
    if (quantity <= 0) {
      alert(currentLang === 'es' ? 'La cantidad debe ser mayor que cero' : 'Quantity must be greater than zero');
      return;
    }
    
    try {
      await db.collection("inventory").add({
        type: type,
        color: color,
        quantity: quantity,
        remaining: quantity,
        price: price,
        date: new Date().toISOString()
      });
      
      alert(currentLang === 'es' ? 'Inventario actualizado correctamente' : 'Inventory updated successfully');
      document.getElementById("inv-quantity").value = "1.00";
      document.getElementById("inv-color").value = "";
      
      // Recargar la lista de inventario
      const inventorySnapshot = await db.collection("inventory")
        .orderBy("date", "desc")
        .get();
      
      const inventoryData = inventorySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderInventoryList(inventoryData);
      
    } catch (error) {
      console.error("Error adding to inventory:", error);
      alert(currentLang === 'es' ? 'Error al actualizar el inventario' : 'Error updating inventory');
    }
  }

  function renderFinancialReports(invoices, customers) {
    // Calcular totales
    let totalSales = 0;
    let totalPending = 0;
    let totalCosts = 0;
    let totalProfit = 0;
    let totalInvoices = invoices.length;
    let totalMargin = 0;
    
    invoices.forEach(invoice => {
      totalSales += invoice.suggestedPrice || 0;
      totalCosts += invoice.totalCost || 0;
      
      if (!invoice.paid) {
        totalPending += invoice.remainingBalance || invoice.suggestedPrice || 0;
      }
      
      if (invoice.totalCost > 0) {
        const margin = ((invoice.suggestedPrice - invoice.totalCost) / invoice.totalCost) * 100;
        totalMargin += margin;
      }
    });
    
    totalProfit = totalSales - totalCosts;
    const avgMargin = totalInvoices > 0 ? (totalMargin / totalInvoices) : 0;
    
    // Actualizar UI
    document.getElementById("total-sales").textContent = totalSales.toFixed(2);
    document.getElementById("total-pending").textContent = totalPending.toFixed(2);
    document.getElementById("total-costs").textContent = totalCosts.toFixed(2);
    document.getElementById("total-profit").textContent = totalProfit.toFixed(2);
    document.getElementById("avg-margin").textContent = avgMargin.toFixed(1);
    document.getElementById("total-invoices").textContent = totalInvoices;
    
    // Renderizar lista de pagos pendientes
    renderPendingPaymentsList(invoices);
  }

  function renderPendingPaymentsList(invoices) {
    const list = document.getElementById("pending-payments-list");
    list.innerHTML = "";
    
    const pendingInvoices = invoices.filter(invoice => !invoice.paid);
    
    if (pendingInvoices.length === 0) {
      list.innerHTML = `<div style="text-align:center; padding:20px; color:#a0aec0;">${currentLang === 'es' ? 'No hay pagos pendientes' : 'No pending payments'}</div>`;
      return;
    }
    
    pendingInvoices.slice(0, 5).forEach(invoice => {
      const div = document.createElement("div");
      div.style.padding = "10px";
      div.style.borderBottom = "1px solid #4a5568";
      
      let paymentInfo = "";
      if (invoice.amountPaid > 0) {
        paymentInfo = `<small>${currentLang === 'es' ? 'Abonado:' : 'Paid:'} RD$${invoice.amountPaid.toFixed(2)} (${currentLang === 'es' ? 'Saldo:' : 'Balance:'} RD$${invoice.remainingBalance.toFixed(2)})</small>`;
      }
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between;">
          <div>
            <strong>${invoice.customerName}</strong><br>
            <small>${invoice.invoiceNumber}</small>
            ${paymentInfo}
          </div>
          <div style="text-align: right;">
            <strong>RD$${invoice.suggestedPrice?.toFixed(2) || '0.00'}</strong><br>
            <small>${new Date(invoice.date).toLocaleDateString()}</small>
          </div>
        </div>
      `;
      list.appendChild(div);
    });
  }

  function renderRecentActivity(invoices) {
    const container = document.getElementById("recent-activity");
    container.innerHTML = "";
    
    if (invoices.length === 0) {
      container.innerHTML = `<div style="text-align:center; padding:20px; color:#a0aec0;">${currentLang === 'es' ? 'No hay actividad reciente' : 'No recent activity'}</div>`;
      return;
    }
    
    invoices.slice(0, 5).forEach(invoice => {
      const div = document.createElement("div");
      div.style.padding = "10px";
      div.style.borderBottom = "1px solid #4a5568";
      
      let paymentInfo = "";
      if ((invoice.status === "received" || invoice.status === "printing") && invoice.amountPaid > 0) {
        paymentInfo = `<small>${currentLang === 'es' ? 'Abonado:' : 'Paid:'} RD$${invoice.amountPaid.toFixed(2)} (${currentLang === 'es' ? 'Saldo:' : 'Balance:'} RD$${invoice.remainingBalance.toFixed(2)})</small>`;
      }
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between;">
          <div>
            <strong>${invoice.customerName}</strong><br>
            <small>${new Date(invoice.date).toLocaleString()}</small>
            ${paymentInfo}
          </div>
          <div style="text-align: right;">
            <strong>RD$${invoice.suggestedPrice?.toFixed(2) || '0.00'}</strong><br>
            <small>${invoice.invoiceNumber}</small>
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  async function checkAlerts() {
    const alertsContainer = document.getElementById("alerts-container");
    alertsContainer.innerHTML = "";
    
    try {
      // Verificar pagos pendientes
      const pendingQuery = await db.collection("invoices")
        .where("paid", "==", false)
        .get();
      
      const pendingAmount = pendingQuery.docs.reduce((sum, doc) => {
        const data = doc.data();
        return sum + (data.remainingBalance || data.suggestedPrice || 0);
      }, 0);
      
      if (pendingAmount > 0) {
        const alertDiv = document.createElement("div");
        alertDiv.className = "alert-banner warning";
        alertDiv.innerHTML = `
          <span>${currentLang === 'es' ? `Tienes ${pendingQuery.size} facturas pendientes por un total de RD$${pendingAmount.toFixed(2)}` : `You have ${pendingQuery.size} pending invoices for a total of RD$${pendingAmount.toFixed(2)}`}</span>
          <button class="btn-payment" style="padding: 5px 10px; font-size: 0.8rem;" onclick="openDashboard(); openTab(event, 'reports-tab')">${currentLang === 'es' ? 'Ver detalles' : 'View details'}</button>
        `;
        alertsContainer.appendChild(alertDiv);
      }
      
      // Verificar inventario bajo
      const inventoryQuery = await db.collection("inventory")
        .orderBy("date", "desc")
        .get();
      
      const lowInventory = [];
      inventoryQuery.forEach(doc => {
        const item = doc.data();
        if (item.remaining < 0.5) { // Menos de 500g
          lowInventory.push(item);
        }
      });
      
      if (lowInventory.length > 0) {
        const alertDiv = document.createElement("div");
        alertDiv.className = "alert-banner info";
        alertDiv.innerHTML = `
          <span>${currentLang === 'es' ? `Bajo inventario: ${lowInventory.map(item => `${item.type} (${item.remaining.toFixed(2)}kg)`).join(', ')}` : `Low inventory: ${lowInventory.map(item => `${item.type} (${item.remaining.toFixed(2)}kg)`).join(', ')}`}</span>
          <button class="btn-save" style="padding: 5px 10px; font-size: 0.8rem;" onclick="openDashboard(); openTab(event, 'inventory-tab')">${currentLang === 'es' ? 'Reponer' : 'Restock'}</button>
        `;
        alertsContainer.appendChild(alertDiv);
      }
      
      // Verificar trabajos recibidos sin avanzar
      const receivedQuery = await db.collection("invoices")
        .where("status", "==", "received")
        .orderBy("date", "asc")
        .get();
      
      if (receivedQuery.size > 0) {
        const oldest = receivedQuery.docs[0].data();
        const daysOld = Math.floor((new Date() - new Date(oldest.date)) / (1000 * 60 * 60 * 24));
        
        if (daysOld > 2) {
          const alertDiv = document.createElement("div");
          alertDiv.className = "alert-banner";
          alertDiv.innerHTML = `
            <span>${currentLang === 'es' ? `Tienes ${receivedQuery.size} trabajos recibidos sin avanzar. El más antiguo tiene ${daysOld} días.` : `You have ${receivedQuery.size} received jobs not started. The oldest is ${daysOld} days old.`}</span>
            <button class="btn-workflow" style="padding: 5px 10px; font-size: 0.8rem;" onclick="openWorkflow()">${currentLang === 'es' ? 'Ver flujo' : 'View workflow'}</button>
          `;
          alertsContainer.appendChild(alertDiv);
        }
      }
      
    } catch (error) {
      console.error("Error checking alerts:", error);
    }
  }

  function getFilamentTypeName(price) {
    switch(price) {
      case 1600: return "PLA";
      case 2000: return "PETG";
      case 2250: return "ABS";
      case 2150: return "ASA";
      default: return currentLang === 'es' ? "Personalizado" : "Custom";
    }
  }

  function loadTemplate(template) {
    document.getElementById("electricityPrice").value = template.electricityPrice || "2.80";
    document.getElementById("printHours").value = template.printHours || "6";
    document.getElementById("weight").value = template.weight || "150";
    document.getElementById("filamentPrice").value = template.filamentPrice || "1600";
    document.getElementById("filamentType").value = template.filamentPrice || "1600";
    document.getElementById("laborCost").value = template.laborCost || "150";
    document.getElementById("otherCosts").value = template.otherCosts || "100";
    document.getElementById("maintenanceCost").value = template.maintenanceCost || "50";
    document.getElementById("printerDepreciation").value = template.printerDepreciation || "14.00";
    document.getElementById("margin").value = template.margin || "40";
    document.getElementById("exchangeRate").value = template.exchangeRate || "58.00";
    
    calculateResults();
    closeModal("dashboardModal");
    
    alert(currentLang === 'es' ? `Plantilla "${template.name}" cargada` : `Template "${template.name}" loaded`);
  }

  async function saveTemplate() {
    const templateName = prompt(currentLang === 'es' ? "Ingrese un nombre para la plantilla:" : "Enter a name for the template:");
    if (!templateName) return;
    
    try {
      await db.collection("templates").add({
        name: templateName,
        electricityPrice: parseFloat(document.getElementById("electricityPrice").value) || 0,
        printHours: parseFloat(document.getElementById("printHours").value) || 0,
        weight: parseFloat(document.getElementById("weight").value) || 0,
        filamentPrice: parseFloat(document.getElementById("filamentPrice").value) || 0,
        laborCost: parseFloat(document.getElementById("laborCost").value) || 0,
        otherCosts: parseFloat(document.getElementById("otherCosts").value) || 0,
        maintenanceCost: parseFloat(document.getElementById("maintenanceCost").value) || 0,
        printerDepreciation: parseFloat(document.getElementById("printerDepreciation").value) || 0,
        margin: parseFloat(document.getElementById("margin").value) || 0,
        exchangeRate: parseFloat(document.getElementById("exchangeRate").value) || 0,
        suggestedPrice: parseFloat(results.suggestedPrice.textContent) || 0,
        createdAt: new Date().toISOString()
      });
      
      alert(currentLang === 'es' ? 'Plantilla guardada con éxito!' : 'Template saved successfully!');
    } catch (error) {
      console.error("Error saving template:", error);
      alert(currentLang === 'es' ? 'Error al guardar la plantilla' : 'Error saving template');
    }
  }

  function createMonthlyProfitChart(invoices) {
    // Agrupar por mes
    const monthlyData = {};
    invoices.forEach(invoice => {
      const date = new Date(invoice.date);
      const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
      
      if (!monthlyData[monthYear]) {
        monthlyData[monthYear] = 0;
      }
      
      monthlyData[monthYear] += invoice.suggestedPrice - invoice.totalCost;
    });
    
    const labels = Object.keys(monthlyData).sort();
    const data = labels.map(label => monthlyData[label]);
    
    const ctx = document.getElementById('monthlyProfitChart').getContext('2d');
    
    if (monthlyProfitChart) {
      monthlyProfitChart.destroy();
    }
    
    monthlyProfitChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: currentLang === 'es' ? 'Ganancias' : 'Profits',
          data: data,
          backgroundColor: 'rgba(255, 159, 67, 0.7)',
          borderColor: 'rgba(255, 159, 67, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'RD$'
            }
          }
        }
      }
    });
  }

  function createFilamentUsageChart(invoices) {
    // Agrupar por tipo de filamento
    const filamentData = {
      "PLA": 0,
      "PETG": 0,
      "ABS": 0,
      "ASA": 0,
      [currentLang === 'es' ? 'Personalizado' : 'Custom']: 0
    };
    
    invoices.forEach(invoice => {
      const filamentPrice = invoice.filamentPrice || 1600;
      let type;
      
      if (filamentPrice === 1600) type = "PLA";
      else if (filamentPrice === 2000) type = "PETG";
      else if (filamentPrice === 2250) type = "ABS";
      else if (filamentPrice === 2150) type = "ASA";
      else type = currentLang === 'es' ? 'Personalizado' : 'Custom';
      
      filamentData[type] += (invoice.weight || 0) / 1000; // Convertir a kg
    });
    
    const labels = Object.keys(filamentData);
    const data = Object.values(filamentData);
    
    const ctx = document.getElementById('filamentUsageChart').getContext('2d');
    
    if (filamentUsageChart) {
      filamentUsageChart.destroy();
    }
    
    filamentUsageChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: [
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 99, 132, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 206, 86, 0.7)'
          ],
          borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(255, 99, 132, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 206, 86, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.label}: ${context.raw.toFixed(2)} kg`;
              }
            }
          }
        }
      }
    });
  }

  function searchCustomers() {
    const searchTerm = document.getElementById("customerSearch").value.toLowerCase();
    const customers = document.querySelectorAll("#customers-list .customer-card");
    
    customers.forEach(customer => {
      const name = customer.querySelector("h3").textContent.toLowerCase();
      if (name.includes(searchTerm)) {
        customer.style.display = "block";
      } else {
        customer.style.display = "none";
      }
    });
  }

  function searchTemplates() {
    const searchTerm = document.getElementById("templateSearch").value.toLowerCase();
    const templates = document.querySelectorAll("#templates-list .template-card");
    
    templates.forEach(template => {
      const name = template.querySelector("h3").textContent.toLowerCase();
      if (name.includes(searchTerm)) {
        template.style.display = "block";
      } else {
        template.style.display = "none";
      }
    });
  }

  async function loadCustomersForAutocomplete() {
    try {
      const querySnapshot = await db.collection("customers").orderBy("name").get();
      const datalist = document.getElementById("customersList");
      datalist.innerHTML = "";
      
      querySnapshot.forEach(doc => {
        const customer = doc.data();
        const option = document.createElement("option");
        option.value = customer.name;
        datalist.appendChild(option);
      });
    } catch (error) {
      console.error("Error loading customers:", error);
    }
  }

  // Funciones de WhatsApp
  function openWhatsAppModal(invoiceId = null) {
    document.getElementById("whatsappModal").style.display = "block";
    
    // Si se proporciona un invoiceId, cargar los datos de esa factura
    if (invoiceId) {
      loadInvoiceForWhatsApp(invoiceId);
    } else {
      // Usar los datos del formulario actual
      updateWhatsAppMessage();
    }
  }

  async function loadInvoiceForWhatsApp(invoiceId) {
    try {
      const doc = await db.collection("invoices").doc(invoiceId).get();
      if (doc.exists) {
        const data = doc.data();
        
        // Actualizar el mensaje con los datos de la factura
        const messagePreview = document.getElementById("whatsapp-message-preview");
        const message = generateWhatsAppMessage(data);
        messagePreview.innerHTML = message.replace(/\n/g, "<br>");
      }
    } catch (error) {
      console.error("Error loading invoice for WhatsApp:", error);
    }
  }

  function updateWhatsAppMessage() {
    const customerName = document.getElementById("customerName").value || (currentLang === 'es' ? "Cliente" : "Customer");
    const invoiceNumber = document.getElementById("invoiceNumber").value || "FAC-00000";
    const totalPrice = results.customerTotalPrice.textContent || "0.00";
    const remainingBalance = document.getElementById("remainingBalance").value || "0.00";
    const status = document.getElementById("status").value;
    
    let message = "";
    
    if (currentWhatsAppTemplate) {
      // Usar la plantilla seleccionada
      message = translations[currentLang][`template-${currentWhatsAppTemplate}-text`];
    } else {
      // Mensaje genérico basado en el estado
      switch(status) {
        case 'received':
          message = translations[currentLang]["template-invoice-text"];
          break;
        case 'printing':
          message = translations[currentLang]["template-printing-text"];
          break;
        case 'completed':
          message = translations[currentLang]["template-completed-text"];
          break;
        case 'delivered':
          message = translations[currentLang]["template-delivered-text"];
          break;
        case 'paid':
          message = translations[currentLang]["template-feedback-text"];
          break;
        default:
          message = translations[currentLang]["template-invoice-text"];
      }
    }
    
    // Reemplazar variables en el mensaje
    message = message.replace(/{cliente}|{customer}/g, customerName)
                    .replace(/{factura}|{invoice}/g, invoiceNumber)
                    .replace(/{total}|{total}/g, totalPrice)
                    .replace(/{saldo}|{balance}/g, remainingBalance);
    
    const messagePreview = document.getElementById("whatsapp-message-preview");
    messagePreview.innerHTML = message.replace(/\n/g, "<br>");
  }

  function useWhatsAppTemplate(template) {
    currentWhatsAppTemplate = template;
    updateWhatsAppMessage();
  }

  function generateWhatsAppMessage(invoiceData) {
    const lang = translations[currentLang];
    const customerName = invoiceData.customerName || (currentLang === 'es' ? "Cliente" : "Customer");
    const invoiceNumber = invoiceData.invoiceNumber || "FAC-00000";
    const totalPrice = invoiceData.suggestedPrice?.toFixed(2) || "0.00";
    const remainingBalance = invoiceData.remainingBalance?.toFixed(2) || "0.00";
    const status = invoiceData.status || "received";
    
    let message = "";
    
    if (currentWhatsAppTemplate) {
      // Usar la plantilla seleccionada
      message = translations[currentLang][`template-${currentWhatsAppTemplate}-text`];
    } else {
      // Mensaje genérico basado en el estado
      switch(status) {
        case 'received':
          message = translations[currentLang]["template-invoice-text"];
          break;
        case 'printing':
          message = translations[currentLang]["template-printing-text"];
          break;
        case 'completed':
          message = translations[currentLang]["template-completed-text"];
          break;
        case 'delivered':
          message = translations[currentLang]["template-delivered-text"];
          break;
        case 'paid':
          message = translations[currentLang]["template-feedback-text"];
          break;
        default:
          message = translations[currentLang]["template-invoice-text"];
      }
    }
    
    // Reemplazar variables en el mensaje
    message = message.replace(/{cliente}|{customer}/g, customerName)
                    .replace(/{factura}|{invoice}/g, invoiceNumber)
                    .replace(/{total}|{total}/g, totalPrice)
                    .replace(/{saldo}|{balance}/g, remainingBalance);
    
    return message;
  }

  function sendWhatsAppMessage() {
    const messagePreview = document.getElementById("whatsapp-message-preview");
    const text = messagePreview.textContent || messagePreview.innerText;
    const phoneNumber = "18493615653"; // Número de WhatsApp Business
    
    // Crear el enlace de WhatsApp
    const encodedMessage = encodeURIComponent(text);
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
    
    // Abrir en una nueva pestaña
    window.open(whatsappUrl, '_blank');
    
    alert(translations[currentLang]["whatsapp-sent"]);
    closeModal("whatsappModal");
  }

  function copyWhatsAppMessage() {
    const messagePreview = document.getElementById("whatsapp-message-preview");
    const text = messagePreview.textContent || messagePreview.innerText;
    
    navigator.clipboard.writeText(text).then(() => {
      alert(translations[currentLang]["message-copied"]);
    }).catch(err => {
      console.error('Error al copiar el mensaje: ', err);
    });
  }

  async function sendStatusNotification() {
    const customerName = document.getElementById("customerName").value;
    const invoiceNumber = document.getElementById("invoiceNumber").value;
    const status = document.getElementById("status").value;
    
    if (!customerName || !invoiceNumber) {
      alert(currentLang === 'es' ? 'Por favor complete los datos del cliente y número de factura' : 'Please fill in customer name and invoice number');
      return;
    }
    
    try {
      // Buscar la factura en Firestore si no está cargada
      let invoiceData;
      if (currentInvoiceId) {
        const doc = await db.collection("invoices").doc(currentInvoiceId).get();
        invoiceData = doc.data();
      } else {
        const invoiceQuery = await db.collection("invoices")
          .where("invoiceNumber", "==", invoiceNumber)
          .limit(1)
          .get();
        
        if (invoiceQuery.empty) {
          alert(currentLang === 'es' ? 'No se encontró la factura' : 'Invoice not found');
          return;
        }
        
        invoiceData = invoiceQuery.docs[0].data();
      }
      
      // Generar el mensaje según el estado
      currentWhatsAppTemplate = status;
      const message = generateWhatsAppMessage(invoiceData);
      
      // Aquí podrías implementar el envío real de la notificación
      // Por ahora solo mostramos un mensaje de éxito
      alert(translations[currentLang]["notification-sent"]);
      
    } catch (error) {
      console.error("Error sending notification:", error);
      alert(currentLang === 'es' ? 'Error al enviar la notificación' : 'Error sending notification');
    }
  }

  // Manejar cambio de tipo de filamento
  document.getElementById("filamentType").addEventListener("change", function() {
    if (this.value !== "custom") {
      document.getElementById("filamentPrice").value = this.value;
      calculateResults();
    }
  });

  // Actualizar saldo pendiente cuando cambia el monto abonado
  document.getElementById("amountPaid").addEventListener("input", function() {
    updateRemainingBalance();
  });

  // Inicialización
  window.onload = async function() {
    translatePage();
    calculateResults();
    await renderHistory();
    await loadCustomersForAutocomplete();
    await checkAlerts();
    
    // Asignar eventos a los inputs
    document.querySelectorAll("input").forEach(input => {
      if (input.id !== "amountPaid") { // Evitar duplicar el evento para amountPaid
        input.addEventListener("input", calculateResults);
      }
    });
    
    document.getElementById("filamentPrice").addEventListener("input", function() {
      if (this.value !== document.getElementById("filamentType").value) {
        document.getElementById("filamentType").value = "custom";
      }
    });
  };
</script>
</body>
</html>